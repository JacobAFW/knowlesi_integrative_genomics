# Consensus DE analysis

## Using de novo assembly

# Prepare environment

```{bash,eval=F}
start_pbs_big_boy
module load R/4.3.1 
export R_LIBS=/home/588/jw1542/.local/lib/R_4.3:$R_LIBS
module load python3/3.12.1
cd /g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses
```

# Convert Trinity outputs to HTSeq format - updated for full matrix

cd /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/output/trinity_assembly/trans_abundance/TMM-normalised

python3 /g/data/pq84/malaria/Pk_trancsriptomics/scripts/trinity_matrix_to_htseq.Py trinity.gene.counts.matrix
python3 /g/data/pq84/malaria/Pk_trancsriptomics/scripts/trinity_matrix_to_htseq.Py trinity.isoform.counts.matrix --output_dir ht_seq_iso

**RUN FOR GENES AND TRANSCRIPTS SEPARATELY**

```{python3,eval=F}
import pandas as pd
import os
import argparse

# Set up command-line argument parser
parser = argparse.ArgumentParser(description="Convert Trinity matrix to per-sample HTSeq-format files.")
parser.add_argument("input_file", help="Path to the Trinity matrix file (e.g., trinity_matrix.txt)")
parser.add_argument("--output_dir", default="ht_seq", help="Directory to save HTSeq files (default: ht_seq)")
args = parser.parse_args()

# Load Trinity matrix
df = pd.read_csv(args.input_file, sep="\t", index_col=0)

# Create output directory if it doesn't exist
os.makedirs(args.output_dir, exist_ok=True)

# Loop through each sample (column)
for sample in df.columns:
    sample_counts = df[[sample]].copy()
    sample_counts.reset_index(inplace=True)
    sample_counts.columns = ["gene_id", "count"]
    
    # Round to nearest integer for HTSeq/DE compatibility
    sample_counts["count"] = sample_counts["count"].round().astype(int)

    # Construct output file path
    output_path = os.path.join(args.output_dir, f"{sample}.txt")

    # Save in HTSeq format
    sample_counts.to_csv(output_path, sep="\t", index=False, header=False)
    print(f"Generated: {output_path}")
```


# Generate dummy GTF for input with consensusDE

python3 /g/data/pq84/malaria/Pk_trancsriptomics/scripts/dummy_gtf_from_trinity.Py trinity.gene.counts.matrix
python3 /g/data/pq84/malaria/Pk_trancsriptomics/scripts/dummy_gtf_from_trinity.Py trinity.isoform.counts.matrix --output_file dummy_iso.gtf


```{python3,eval=F}
#!/usr/bin/env python3

import pandas as pd
import argparse

# Argument parser setup
parser = argparse.ArgumentParser(description="Generate a dummy GTF file from a Trinity count matrix.")
parser.add_argument("input_file", help="Path to the Trinity matrix file (e.g., trinity_matrix.txt)")
parser.add_argument("--output_file", default="dummy.gtf", help="Output GTF filename (default: dummy.gtf)")
args = parser.parse_args()

# Load Trinity matrix
df = pd.read_csv(args.input_file, sep="\t", index_col=0)
transcript_ids = df.index.to_list()

# Write fixed GTF
with open(args.output_file, "w") as gtf:
    for tx in transcript_ids:
        # Extract gene_id from transcript (everything before _iX)
        gene_id = "_".join(tx.split("_")[:-1])
        # Use full transcript ID as seqname (1st column) to ensure uniqueness
        line = (
            f"{tx}\tTrinity\texon\t1\t1000\t.\t+\t.\t"
            f'gene_id "{gene_id}"; transcript_id "{tx}";\n'
        )
        gtf.write(line)

print(f"✅ Fixed dummy GTF saved as: {args.output_file}")
```


# Remove hyphens from names - causes issues in R

```{R,eval=F}
cd /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/output/trinity_assembly/trans_abundance/TMM-normalised/ht_seq_iso

for f in *-*.txt; do
  mv "$f" "$(echo "$f" | tr '-' '_')"
done
```

# Prepare data

```{R,eval=F}
library(consensusDE)
library(tidyverse)
library(readxl)

## Import & wrangle metadata
linkage_meta <- read_xlsx("/g/data/pq84/malaria/Pk_trancsriptomics/data/batch2/PK_Sabah_Samples.xlsx") %>%
    mutate(sampleid = str_replace(sampleid, "D", "R")) %>%
    mutate(subjectid = ifelse(str_length(subjectid) == 1, paste0("00", subjectid), # if subjectid length = 1 paste 00
        ifelse(str_length(subjectid) == 2, paste0("0", subjectid), # if not, then if subjectid length = 2 paste 0
        .$subjectid))) %>%
    mutate(studyid = paste(group, subjectid, sep = "")) %>%
    select(sampleid, severe, studyid) %>%
    rbind(
        read_xlsx("/g/data/pq84/malaria/Pk_trancsriptomics/data/batch2/pk_sb_rna_set2_samplecodes.xlsx") %>%
            rename(sampleid = sample.name, severe = severity, studyid = sample.id, parasitemia = par) %>%
            select(sampleid, severe, studyid)
    )

gwas_metadata <- read_tsv("/g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/human_genomics/axiom_array/outdir/analyses/gwas_metadata.tsv")

sample_list <- list.files(path = "/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/ht_seq", pattern = "genes.txt", full = TRUE) %>%
    data.frame("sampleid"=basename(.)) %>%
    rename(file = ".") %>%
    mutate(file = str_remove(file, ".*ht_seq/")) %>%
    mutate(sampleid = str_remove(sampleid, "_DK.*")) %>%
    mutate(sampleid = str_remove(sampleid, "_RSEM.*")) %>% 
    mutate(sampleid = str_remove(sampleid, "_HALF")) %>%
    mutate(sampleid = str_remove(sampleid, "ZS_")) 

full_meta <- sample_list %>%
    left_join(linkage_meta, by = "sampleid") %>%
    left_join(
        gwas_metadata %>%
            rename(studyid = Sample)
    ) %>%
    select(-c(case, severe))
    
missing_data <- full_meta %>%
    filter(is.na(sevemal)) %>%
    select(file, sampleid, studyid) %>%
    left_join(
        read_xlsx("/g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/human_genomics/axiom_array/outdir/analyses/Sabah_MASTER_patientsummary_22.2.23.xlsx") %>%
            rename(studyid = code) %>%
            select(studyid, sevmal_baseline, researchcount, hospcount, age, sex) %>%
            mutate(researchcount = ifelse(researchcount == 0 & !is.na(hospcount), hospcount, researchcount)) %>%
            rename(sevemal = sevmal_baseline, parasitemia = researchcount) %>%
            mutate(sevemal = ifelse(grepl("UM", sevemal), "Um", ifelse(grepl("SM", sevemal), "Sm", sevemal))) %>%
            select(-hospcount)
    )

full_meta <- full_meta %>% 
    na.omit() %>%
    rbind(missing_data) 

#write_tsv(full_meta, "full_meta_for_de.tsv")


# Build summaries
sample_table <- missing_data %>%
    select(file, sevemal) %>%
    rename(group = sevemal)

summarized_Hs <- buildSummarized(sample_table = sample_table, 
    htseq_dir = "/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/ht_seq/", 
    read_format = "paired", 
    output_log = "/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/consensusDE_log/",
    gtf = "/g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_abundaces_only/output/genome_annotation/Trinity.gtf")

# Save as GDS for easy access (step above can take several hours)
saveRDS(summarized_Hs, file = "summarized_de.rds")
```

# Hybrid analysis using ConsensusDE and custom scripting

## For gene and isoform

cd /g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv
R

```{r}
# Load necessary libraries
library(consensusDE)
library(tidyverse)
library(readxl)
library(SummarizedExperiment)
library(magrittr)
library(edgeR)
library(RUVSeq)
library(Biobase)
library(DESeq2)
library(pheatmap)
library(limma)
library(patchwork)
library(matrixStats)  


# Load data
summarised_de <- readRDS("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/summarised_de_iso.rds")
sample_table <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/sample_table.tsv")

# Library size
library_sizes <- assay(summarised_de) %>% 
    colSums()

summary_stats <- summary(library_sizes)
capture.output(summary_stats, file = "library_sizes.tsv")

# Initialize log
filter_log <- NULL
log_filter_counts <- function(se, step_label, log_df = NULL) {
  tibble(step = step_label, n_samples = ncol(se), n_transcripts = nrow(se)) %>%
    bind_rows(log_df, .)
}

# STEP 0: Raw data
filter_log <- log_filter_counts(summarised_de, "Initial (raw summarised_de)", filter_log)

# STEP 1: consensusDE filtering
summarised_de_filter <- buildSummarized(
  summarized = summarised_de, 
  sample_table = sample_table,
  filter = TRUE, 
  output_log = "/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/consensusDE_log"
)
filter_log <- log_filter_counts(summarised_de_filter, "After buildSummarized (filter = TRUE)", filter_log)

# STEP 2: Remove samples with missing group
summarised_de_filter <- summarised_de_filter[, !is.na(colData(summarised_de_filter)$group)]
filter_log <- log_filter_counts(summarised_de_filter, "Removed samples with NA group", filter_log)

# STEP 3: Remove all-zero transcripts
summarised_de_filter <- summarised_de_filter[rowSums(assay(summarised_de_filter)) > 0, ]
filter_log <- log_filter_counts(summarised_de_filter, "Removed transcripts with all-zero counts", filter_log)

# Library size - post filtering and pre CPM
library_sizes <- assay(summarised_de_filter) %>% 
    colSums()

summary_stats <- summary(library_sizes)
capture.output(summary_stats, file = "library_sizes_filter_pre_cpm.tsv")

# STEP 4: CPM > X in ≥ X samples - only has an impact if you adjust the sample number
# otherwise, buildSummarized will already clean up the data
keep <- assay(summarised_de_filter) %>%
  DGEList() %>%
  cpm() %>%
  { rowSums(. > 1) >= 10 }
summarised_de_filter <- summarised_de_filter[keep, ]
filter_log <- log_filter_counts(summarised_de_filter, "Filtered by CPM > 1 in ≥3 samples", filter_log)

# Library size - post CPM
library_sizes <- assay(summarised_de_filter) %>% 
    colSums()

summary_stats <- summary(library_sizes)
capture.output(summary_stats, file = "library_sizes_filter_post_cpm.tsv")

# STEP 5: Remove high-count transcripts (mean > 50k)
transcript_means <- rowMeans(assay(summarised_de_filter))
summarised_de_filter <- summarised_de_filter[transcript_means < 5e4, ]
filter_log <- log_filter_counts(summarised_de_filter, "Removed transcripts with mean > 50,000", filter_log)

# Save high-count summary
tibble(
  threshold = c(">50k", ">100k"),
  n_transcripts = c(sum(transcript_means > 5e4), sum(transcript_means > 1e5))
) %>% write_tsv("qc_high_expression_transcripts.tsv")

# STEP 6: Create SeqExpressionSet for RUV
# Extract colData and convert to data frame

# Combine IDC and metadata
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  left_join(
      read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt")
  ) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) %>%
  mutate(schizont = schizont * 100,
    ring = ring * 100,
    trophozoite = trophozoite * 100)

meta_idc_combined <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/full_meta_for_de.tsv") %>%
  dplyr::rename(sample = file) %>%
  mutate(sample_id = str_remove(sample, ".txt")) %>%
  left_join(
    idc_df,
    by = "sample_id"
  )
    
# Combine with de object
coldata <- colData(summarised_de_filter) %>%
  as.data.frame() %>%
  rownames_to_column("sample") %>%
  left_join(
    meta_idc_combined, 
    by = "sample") %>%
  column_to_rownames("sample") %>%
  DataFrame() 

colData(summarised_de_filter) <- coldata

pheno <- AnnotatedDataFrame(as(colData(summarised_de_filter), "data.frame"))
ruv_set <- newSeqExpressionSet(
  counts = as.matrix(assay(summarised_de_filter)),
  phenoData = pheno
)

# STEP 7: Compute residuals from a first-pass GLM regression
design <- model.matrix(~batch + group, data = pData(ruv_set))
dge <- DGEList(counts = counts(ruv_set), group = pData(ruv_set)$group)
dge <- calcNormFactors(dge, method = "TMM")
dge <- estimateDisp(dge, design)
fit <- glmFit(dge, design)
residuals_matrix <- residuals(fit, type = "deviance")

# STEP 8: Apply RUVr to estimate unwanted variation factors
control_genes <- rownames(ruv_set)  # Using all genes as controls
k <- 1  # Number of unwanted factors to estimate; adjust based on your data
ruv_set <- RUVr(ruv_set, cIdx = control_genes, k = k, residuals = residuals_matrix)

# STEP 9: Incorporate RUV factors into colData
colData(summarised_de_filter)$W_1 <- pData(ruv_set)$W_1

# STEP 10: Remove rows with any NA in counts
summarised_de_filter <- summarised_de_filter[rowSums(is.na(assay(summarised_de_filter))) == 0, ]
filter_log <- log_filter_counts(summarised_de_filter, "Removed transcripts with any NA values", filter_log)

# STEP 11: Export log
write_tsv(filter_log, "filtering_summary_log.tsv")

# Save as GDS for easy access (step above can take a while)
#saveRDS(summarised_de_filter, file = "summarized_de_filter.rds")

#####################################################


# Plot distribution of counts across transcripts

# Convert assay to long format
count_distribution <- assay(summarised_de_filter) %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "count")

# Optional: remove 0s for cleaner plot (keeps > 0 counts only)
count_distribution_filtered <- count_distribution %>%
  filter(count > 0)

# Plot transcript expression distribution
transcript_means <- assay(summarised_de_filter) %>%
  rowMeans()

# Calculate quantiles
low_cutoff <- quantile(transcript_means, 0.05)
high_cutoff <- quantile(transcript_means, 0.99)

# Plot with overlays
export_plot <- ggplot(data.frame(mean_count = transcript_means), aes(x = mean_count)) +
  geom_histogram(bins = 100, fill = "grey70") +
  geom_vline(xintercept = low_cutoff, color = "#440154FF", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = high_cutoff, color = "#55C667FF", linetype = "dashed", linewidth = 1) +
  scale_x_log10() +
  labs(
    title = "Transcript Expression Distribution",
    x = "Mean Counts (log10)",
    y = "Transcript Count"
  )

ggsave("transcript_expression_distribution_with_cutoffs.png", plot = export_plot, dpi = 300)



#####################################################

# DE analysis
# Build DESeq2 object
# Relevel the group factor in colData
colData(summarised_de_filter)$group <- relevel(colData(summarised_de_filter)$group, ref = "Um")

# Build DESeq2 object
dds <- DESeqDataSetFromMatrix(
  countData = round(assay(summarised_de_filter)),
  colData = colData(summarised_de_filter),
  design = ~ batch + W_1 + group
)

# Run DESeq2
dds <- DESeq(dds)
resultsNames(dds)

# Now this line reflects "Sm vs Um"
res <- results(dds, name = "group_Sm_vs_Um")


# Save p-value distribution plot
export_plot <- ggplot(as.data.frame(res), aes(x = pvalue)) +
  geom_histogram(bins = 50, fill = "grey30") +
  labs(title = "DESeq2 P-value Distribution", x = "p-value", y = "Frequency")

ggsave("pval_hist_deseq2.png", plot = export_plot, dpi = 300)


# PCA
plot_pca_pairs <- function(pca_scores,
                           color_var,
                           tool_label = "deseq2",
                           filename_prefix = "pca",
                           log_transform = FALSE,
                           color_scheme = NULL,
                           pcs = c(1, 2, 3)) {

  # If log transformation is needed
  if (log_transform) {
    color_col <- paste0("log10_", color_var)
    pca_scores[[color_col]] <- log10(pca_scores[[color_var]])
    color_var <- color_col
  }

  # Loop over all PC combinations (e.g., PC1 vs PC2, PC1 vs PC3)
  for (i in seq_along(pcs)) {
    for (j in seq_along(pcs)) {
      if (i < j) {
        pc_x <- pcs[i]
        pc_y <- pcs[j]
        pcx_name <- paste0("PC", pc_x)
        pcy_name <- paste0("PC", pc_y)

        x_lab <- paste0("PC", pc_x, ": ", round(attr(pca_scores, "var_expl")[pc_x] * 100, 2), "% variance")
        y_lab <- paste0("PC", pc_y, ": ", round(attr(pca_scores, "var_expl")[pc_y] * 100, 2), "% variance")

        export_plot <- ggplot(pca_scores, aes_string(x = pcx_name, y = pcy_name)) +
          geom_point(aes_string(colour = color_var)) +
          xlab(x_lab) +
          ylab(y_lab)

        # Add color scale
        if (is.numeric(pca_scores[[color_var]])) {
          export_plot <- export_plot + scale_color_viridis_c()
        } else if (!is.null(color_scheme)) {
          export_plot <- export_plot + scale_color_manual(values = color_scheme)
        }

        # Save the file
        filename <- sprintf("%s_%s_%s_PC%s_PC%s.png", filename_prefix, tool_label, gsub("log10_", "", color_var), pc_x, pc_y)
        ggsave(filename, plot = export_plot, dpi = 300)
      }
    }
  }
}

# Create PCA object and attach variance info
vsd <- vst(dds, blind = TRUE)
pca_obj <- prcomp(t(assay(vsd)))
var_expl <- summary(pca_obj)$importance[2, ]

pca_scores <- data.frame(
    PC1 = pca_obj$x[, 1],
    PC2 = pca_obj$x[, 2],
    PC3 = pca_obj$x[, 3],
    sample = rownames(pca_obj$x),
    group = colData(vsd)$group
    ) %>%
    mutate(sample = str_remove(sample, "_DK.*|_HALF.*|.txt"),
        sample = str_remove(sample, "ZS_")) %>%
        left_join(
          meta_idc_combined %>%
            mutate(sample = sampleid)
        )

attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "deseq2", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "deseq2", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "parasitemia", tool_label = "deseq2", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "age", tool_label = "deseq2", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "deseq2", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "sex", tool_label = "deseq2", color_scheme = c("F" = "#440154FF", "M" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))
plot_pca_pairs(pca_scores, color_var = "schizont", tool_label = "deseq2", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "ring", tool_label = "deseq2", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "trophozoite", tool_label = "deseq2", log_transform = TRUE)


# Pf IDC

idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores <- pca_scores %>% 
  select(-c(celltype, schizont, ring, trophozoite)) %>%
  left_join(
    idc_df
  )

plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_pf", 
  color_scheme = c("trophozoite" = "#440154FF", 
                   "schizont" = "#55C667FF", 
                   "ring" = "black", 
                   "gametocyte_female" = "#3B528BFF", 
                     "gametocyte_developing" = "#21908CFF", 
                     "gametocyte_male" = "#FDE725FF"))


# Volcano plot
res_df <- as.data.frame(res) %>%
  rownames_to_column("gene") %>%
  mutate(sig = padj < 0.001 & abs(log2FoldChange) > 1)

export_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(pvalue), color = sig)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("grey70", "#f57d15")) +
  labs(title = "Volcano Plot (DESeq2)", x = "log2 Fold Change", y = "-log10 p-value")

ggsave("volcano_deseq2.png", plot = export_plot, dpi = 300)

# Heatmap of top 30 DE genes
top_genes <- res_df %>%
  filter(!is.na(padj)) %>%
  arrange(padj) %>%
  head(30) %>%
  pull(gene)

export_plot <- pheatmap(assay(vsd)[top_genes, ],
                        cluster_rows = TRUE,
                        cluster_cols = TRUE,
                        annotation_col = as.data.frame(colData(vsd)[, "group", drop = FALSE]),
                        show_rownames = TRUE,
                        show_colnames = FALSE)

# Save heatmap as file
ggsave("heatmap_deseq2_top30.png", plot = export_plot[[4]], dpi = 300)

res_deseq2_full <- as.data.frame(res) %>%
  rownames_to_column("gene")

write_tsv(res_deseq2_full, "deseq2_results_full.tsv")



# PCA on top 1,000 most variable genes, NOT accounting for batch effect
vsd <- vst(dds, blind = TRUE)
top_variable_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 1000)
vsd_top_var <- vsd[top_variable_genes, ]
pca_results <- prcomp(t(assay(vsd_top_var)))
var_expl <- summary(pca_results)$importance[2, ]


# Prepare PCA scores for plotting
pca_scores <- as.data.frame(pca_results$x) %>%
  rownames_to_column("file") %>%
  left_join(as.data.frame(colData(vsd_top_var)), by = "file")

attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "deseq2_top_1000", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "deseq2_top_1000", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "deseq2_top_1000", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_top_1000", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))
plot_pca_pairs(pca_scores, color_var = "schizont", tool_label = "deseq2_top_1000", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "ring", tool_label = "deseq2_top_1000", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "trophozoite", tool_label = "deseq2_top_1000", log_transform = TRUE)


# Pf IDC

idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores <- pca_scores %>% 
  select(-c(celltype, schizont, ring, trophozoite)) %>%
  left_join(
    idc_df
  )

plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_pf_1000", 
  color_scheme = c("trophozoite" = "#440154FF", 
                   "schizont" = "#55C667FF", 
                   "ring" = "black", 
                   "gametocyte_female" = "#3B528BFF", 
                     "gametocyte_developing" = "#21908CFF", 
                     "gametocyte_male" = "#FDE725FF"))

# PCA on top 1,000 most variable genes whilst accounting for batch effect

# Apply variance stabilizing transformation
vsd <- vst(dds, blind = FALSE)
assay(vsd) <- removeBatchEffect(assay(vsd), 
  batch = vsd$batch, 
  covariates = vsd$W_1)
top_variable_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 1000)
vsd_top_var <- vsd[top_variable_genes, ]
pca_results <- prcomp(t(assay(vsd_top_var)))
var_expl <- summary(pca_results)$importance[2, ]

# Prepare PCA scores for plotting
pca_scores <- as.data.frame(pca_results$x) %>%
  rownames_to_column("file") %>%
  left_join(as.data.frame(colData(vsd_top_var)), by = "file")

attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "deseq2_top_1000_batch_corrected", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "deseq2_top_1000_batch_corrected", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "deseq2_top_1000_batch_corrected", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_top_1000_batch_corrected", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))

# Pf IDC

idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores <- pca_scores %>% 
  select(-c(celltype, schizont, ring, trophozoite)) %>%
  left_join(
    idc_df
  )

plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_pf_1000_batch_corrected", 
  color_scheme = c("trophozoite" = "#440154FF", 
                   "schizont" = "#55C667FF", 
                   "ring" = "black", 
                   "gametocyte_female" = "#3B528BFF", 
                     "gametocyte_developing" = "#21908CFF", 
                     "gametocyte_male" = "#FDE725FF"))

# PCA accounting for batch on all genes

# Perform PCA
pca_results <- prcomp(t(assay(vsd)))

# Prepare PCA scores for plotting
pca_scores <- as.data.frame(pca_results$x) %>%
  rownames_to_column("file") %>%
  left_join(as.data.frame(colData(vsd_top_var)), by = "file")

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "deseq2_batch_corrected_group", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))



# PCA on significant genes

sig_genes_deseq2 <- res_df %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  pull(gene)

vsd_sig <- vsd[sig_genes_deseq2, ]
pca_results <- prcomp(t(assay(vsd_top_var)))
var_expl <- summary(pca_results)$importance[2, ]


# Prepare PCA scores for plotting
pca_scores <- as.data.frame(pca_results$x) %>%
  rownames_to_column("file") %>%
  left_join(as.data.frame(colData(vsd_top_var)), by = "file")

attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "deseq2_sig", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "deseq2_sig", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "deseq2_sig", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_sig", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))


# Pf IDC

idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores <- pca_scores %>% 
  select(-c(celltype, schizont, ring, trophozoite)) %>%
  left_join(
    idc_df
  )

plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "deseq2_pf_sig", 
  color_scheme = c("trophozoite" = "#440154FF", 
                   "schizont" = "#55C667FF", 
                   "ring" = "black", 
                   "gametocyte_female" = "#3B528BFF", 
                     "gametocyte_developing" = "#21908CFF", 
                     "gametocyte_male" = "#FDE725FF"))


# Dispersion plots - should follow red trend line
png("deseq2_dispersion_plot.png", width = 1800, height = 1500, res = 300)
plotDispEsts(dds)
dev.off()

# Cooks distance - influential samples
png("deseq2_cooks_distance.png", width = 1800, height = 1500, res = 300)
plotCounts(dds, gene = which.max(assays(dds)[["cooks"]][,1]), intgroup = "group")
dev.off()

# MA Plot
res_df_ma <- as.data.frame(res)
res_df_ma$neg_log_pval <- -log10(res_df_ma$pvalue) # Add a column for -log10(p-value) for coloring

# Create the MA plot
ma_plot_deseq2 <- ggplot(res_df_ma, aes(x = log10(baseMean), y = log2FoldChange, color = neg_log_pval)) +
  geom_point(alpha = 0.6) +
  scale_color_viridis_c(option = "viridis") +
  labs(
    x = "Log10 Mean Expression",
    y = "Log2 Fold Change",
    color = "-Log10(P-Value)"
  )

# Save the plot to a file
ggsave(filename = "deseq2_MA_Plot.png", plot = ma_plot_deseq2, width = 10, dpi = 300)



#####################################################



# edgeR

# Setup
counts <- round(assay(summarised_de_filter))
meta <- colData(summarised_de_filter)

# Extract RUV factors (e.g., W_1, W_2 if you used k = 2)
W_vars <- grep("^W_", colnames(meta), value = TRUE)
design_formula <- as.formula(paste("~ batch +", paste(c(W_vars, "group"), collapse = " + ")))
design <- model.matrix(design_formula, data = meta)

# Create DGEList
dge <- DGEList(counts = counts)
dge <- calcNormFactors(dge)

# Estimate dispersions
dge <- estimateDisp(dge, design)

# Fit GLM
fit <- glmFit(dge, design)

# Contrast (adjust based on your actual group levels)
# If your levels are group_Control and group_Treated, check colnames(design)
contrast_name <- grep("^group", colnames(design), value = TRUE)
lrt <- glmLRT(fit, coef = contrast_name)

# Extract results
res_edgeR <- topTags(lrt, n = Inf)$table

# Save p-value distribution plot
export_plot <- ggplot(res_edgeR, aes(x = PValue)) +
  geom_histogram(bins = 50, fill = "grey30") +
  labs(title = "edgeR P-value Distribution", x = "p-value", y = "Frequency")

ggsave("pval_hist_edgeR.png", plot = export_plot, dpi = 300)

# PCA from log-CPM
logcpm <- cpm(dge, log = TRUE, prior.count = 1)
pca_obj <- prcomp(t(logcpm))
var_expl <- summary(pca_obj)$importance[2, ]

# Join metadata
pca_scores <- data.frame(
    PC1 = pca_obj$x[, 1],
    PC2 = pca_obj$x[, 2],
    PC3 = pca_obj$x[, 3],
    sample = colnames(logcpm),
    group = meta$group,
    W_1 = meta$W_1
    ) %>%
    mutate(sample = str_remove(sample, "_DK.*|_HALF.*|.txt"),
        sample = str_remove(sample, "ZS_")) %>%
        left_join(
          meta_idc_combined %>%
            mutate(sample = sampleid)
        )

attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "edger", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "edger", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "parasitemia", tool_label = "edger", color_scheme = "viridis_continuous")
plot_pca_pairs(pca_scores, color_var = "age", tool_label = "edger", color_scheme = "viridis_continuous")
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "edger", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "sex", tool_label = "edger", color_scheme = c("F" = "#440154FF", "M" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "edger", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))
plot_pca_pairs(pca_scores, color_var = "schizont", tool_label = "edger", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "ring", tool_label = "edger", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "trophozoite", tool_label = "edger", log_transform = TRUE)

# Volcano plot
res_edgeR_vol <- res_edgeR %>%
  rownames_to_column("gene") %>%
  mutate(sig = FDR < 0.05 & abs(logFC) > 1)

export_plot <- ggplot(res_edgeR_vol, aes(x = logFC, y = -log10(PValue), color = sig)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("grey70", "#f57d15")) +
  labs(title = "Volcano Plot (edgeR)", x = "log2 Fold Change", y = "-log10 p-value")

ggsave("volcano_edgeR.png", plot = export_plot, dpi = 300)

# Heatmap of top 30 DE genes
top_genes <- res_edgeR_vol %>%
  arrange(FDR) %>%
  head(30) %>%
  pull(gene)

# Set up annotation with proper rownames
annotation_col <- data.frame(group = meta$group)
rownames(annotation_col) <- colnames(logcpm)

# Generate heatmap and assign to export_plot
export_plot <- pheatmap(logcpm[top_genes, ],
                        cluster_rows = TRUE,
                        cluster_cols = TRUE,
                        annotation_col = annotation_col,
                        show_rownames = TRUE,
                        show_colnames = FALSE)

ggsave("heatmap_edgeR_top30.png", plot = export_plot[[4]], dpi = 300)

res_edgeR_full <- topTags(lrt, n = Inf)$table %>%
  rownames_to_column("gene")

write_tsv(res_edgeR_full, "edgeR_results_full.tsv")

# PCA on significant genes

# Subset significant genes
sig_genes_edger <- res_edgeR %>%
  rownames_to_column("gene") %>%
  filter(!is.na(FDR), FDR < 0.001, abs(logFC) > 1) %>%
  pull(gene)

logcpm_sig <- logcpm[sig_genes_edger, ]

# PCA
pca_data <- prcomp(t(logcpm_sig))
pca_scores <- data.frame(PC1 = pca_data$x[, 1],
                         PC2 = pca_data$x[, 2],
                         sample = colnames(logcpm_sig),
                         group = meta$group)

export_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = group)) +
  labs(
    title = "PCA on Significant DE Genes (edgeR)",
    x = paste0("PC1: ", round(summary(pca_data)$importance[2, 1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(summary(pca_data)$importance[2, 2] * 100, 2), "% variance")
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_edger_sig_genes.png", plot = export_plot, dpi = 300)


# PCA on top 1,000 most variable genes

# Calculate variance for each gene
gene_variances <- rowVars(logcpm)

# Select the top 1,000 most variable genes
top_variable_genes <- order(gene_variances, decreasing = TRUE)[1:1000]

# Subset the log-CPM matrix to include only these genes
logcpm_top_var <- logcpm[top_variable_genes, ]

# Perform PCA
pca_results <- prcomp(t(logcpm_top_var))

pca_scores <- data.frame(
  PC1 = pca_results$x[, 1],
  PC2 = pca_results$x[, 2],
  sample = colnames(logcpm_top_var),
    group = meta$group,
    W_1 = meta$W_1
)

pca_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2, color = group)) +
  geom_point(size = 3) +
  labs(
    title = "PCA on Top 1,000 Most Variable Genes (edgeR)",
    x = paste0("PC1: ", round(summary(pca_results)$importance[2, 1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(summary(pca_results)$importance[2, 2] * 100, 2), "% variance")
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_edger_top_1000_variable_genes.png", plot = pca_plot, dpi = 300)

# Biological coefficient of variation (BCV) plot - “clean” curve suggests stable dispersion estimate
png("edger_bcv_plot.png", width = 1800, height = 1500, res = 300)
plotBCV(dge)
dev.off()


# MA Plot
res_df_ma <- as.data.frame(res_edgeR)
res_df_ma$neg_log_pval <- -log10(res_df_ma$PValue)

ma_plot_edger <- ggplot(res_df_ma, aes(x = logCPM, y = logFC, color = neg_log_pval)) +
  geom_point(alpha = 0.6) +
  scale_color_viridis_c(option = "viridis") +
  labs(
    x = "Log CPM",
    y = "Log Fold Change",
    color = "-Log10(P-Value)"
  )

ggsave(filename = "edger_MA_Plot.png", plot = ma_plot_edger, width = 10, dpi = 300)



#####################################################



# voom-limma

# Setup
counts <- round(assay(summarised_de_filter))
meta <- colData(summarised_de_filter)

# Extract RUV factors (e.g., W_1, W_2 if k = 2)
W_vars <- grep("^W_", colnames(meta), value = TRUE)

# Ensure 'group' is a factor
meta$group <- factor(meta$group)

# Design matrix including RUV factors and group
design_formula <- as.formula(paste("~ batch +", paste(c(W_vars, "group"), collapse = " + ")))
design <- model.matrix(design_formula, data = meta)

# Create DGEList object
dge <- DGEList(counts = counts)
dge <- calcNormFactors(dge)

# Apply voom transformation
v <- voom(dge, design, plot = TRUE)

# Save the mean-variance trend plot
ggsave("voom_mean_variance_plot.png", dpi = 300)

# Fit linear model
fit <- lmFit(v, design)
fit <- eBayes(fit)

# Extract results
voom_res <- topTable(fit, coef = "groupSm", number = Inf, sort.by = "P")

# Save p-value histogram
export_plot <- ggplot(voom_res, aes(x = P.Value)) +
  geom_histogram(bins = 50, fill = "grey30") +
  labs(title = "Voom P-value Distribution", x = "p-value", y = "Frequency")

ggsave("pval_hist_voom.png", plot = export_plot, dpi = 300)

# PCA from voom logCPM
pca_obj <- prcomp(t(v$E))
var_expl <- summary(pca_obj)$importance[2, ]

# Create PCA scores dataframe
pca_scores <- data.frame(
    PC1 = pca_obj$x[, 1],
    PC2 = pca_obj$x[, 2],
    PC3 = pca_obj$x[, 3],
    sample = colnames(v$E),
    group = meta$group,
    W_1 = meta$W_1
    ) %>%
    mutate(sample = str_remove(sample, "_DK.*|_HALF.*|.txt"),
        sample = str_remove(sample, "ZS_")) %>%
        left_join(
          meta_idc_combined %>%
            mutate(sample = sampleid)
        )


attr(pca_scores, "var_expl") <- var_expl

plot_pca_pairs(pca_scores, color_var = "group", tool_label = "voom", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "cluster", tool_label = "voom", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "parasitemia", tool_label = "voom", color_scheme = "viridis_continuous")
plot_pca_pairs(pca_scores, color_var = "age", tool_label = "voom", color_scheme = "viridis_continuous")
plot_pca_pairs(pca_scores, color_var = "batch", tool_label = "voom", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "sex", tool_label = "voom", color_scheme = c("F" = "#440154FF", "M" = "#55C667FF"))
plot_pca_pairs(pca_scores, color_var = "celltype", tool_label = "voom", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))
plot_pca_pairs(pca_scores, color_var = "schizont", tool_label = "voom", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "ring", tool_label = "voom", log_transform = TRUE)
plot_pca_pairs(pca_scores, color_var = "trophozoite", tool_label = "voom", log_transform = TRUE)

# Volcano plot
voom_res_df <- voom_res %>%
  rownames_to_column("gene") %>%
  mutate(sig = adj.P.Val < 0.05 & abs(logFC) > 1)

export_plot <- ggplot(voom_res_df, aes(x = logFC, y = -log10(P.Value), color = sig)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("grey70", "#f57d15")) +
  labs(title = "Volcano Plot (voom)", x = "log2 Fold Change", y = "-log10 p-value")

ggsave("volcano_voom.png", plot = export_plot, dpi = 300)

# Heatmap of top 30 DE genes
top_genes_voom <- voom_res_df %>%
  arrange(adj.P.Val) %>%
  head(30) %>%
  pull(gene)

annotation_col <- data.frame(group = meta$group)
rownames(annotation_col) <- colnames(v$E)

export_plot <- pheatmap(v$E[top_genes_voom, ],
                        cluster_rows = TRUE,
                        cluster_cols = TRUE,
                        annotation_col = annotation_col,
                        show_rownames = TRUE,
                        show_colnames = FALSE)

png("heatmap_voom_top30.png", width = 2000, height = 2000, res = 300)
grid::grid.newpage()
grid::grid.draw(export_plot$gtable)
dev.off()

voom_res_full <- voom_res %>%
  rownames_to_column("gene")

write_tsv(voom_res_full, "voom_results_full.tsv")

# PCA on significant genes

# Subset significant genes
sig_genes_voom <- voom_res_df %>%
  filter(!is.na(adj.P.Val), adj.P.Val < 0.05, abs(logFC) > 1) %>%
  pull(gene)

voom_sig <- v$E[sig_genes_voom, ]

# PCA
pca_data <- prcomp(t(voom_sig))
pca_scores <- data.frame(PC1 = pca_data$x[, 1],
                         PC2 = pca_data$x[, 2],
                         sample = colnames(voom_sig),
                         group = meta$group)

export_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = group)) +
  labs(
    title = "PCA on Significant DE Genes (voom)",
    x = paste0("PC1: ", round(summary(pca_data)$importance[2, 1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(summary(pca_data)$importance[2, 2] * 100, 2), "% variance")
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_sig_genes.png", plot = export_plot, dpi = 300)


# PCA on top 1,000 most variable genes

# Calculate variance for each gene
gene_variances <- rowVars(v$E)

# Select the top 1,000 most variable genes
top_variable_genes <- order(gene_variances, decreasing = TRUE)[1:1000]

# Subset the expression matrix to include only these genes
voom_top_var <- v$E[top_variable_genes, ]

# Perform PCA
pca_results <- prcomp(t(voom_top_var))

pca_scores <- data.frame(
  PC1 = pca_results$x[, 1],
  PC2 = pca_results$x[, 2],
  sample = colnames(voom_top_var),
  group = meta$group
)

pca_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2, color = group)) +
  geom_point(size = 3) +
  labs(
    title = "PCA on Top 1,000 Most Variable Genes (voom)",
    x = paste0("PC1: ", round(summary(pca_results)$importance[2, 1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(summary(pca_results)$importance[2, 2] * 100, 2), "% variance")
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_top_1000_variable_genes.png", plot = pca_plot, dpi = 300)

# Residual Standard Deviation Plot
design_simple <- model.matrix(~ meta$group)
v_simple <- voom(dge, design_simple, plot = TRUE)
ggsave("voom_mean_variance_plot.png", dpi = 300)

saveRDS(v$weights, file = "voom_weights.rds")

png("voom_mean_variance_trend.png", width = 1800, height = 1500, res = 300)
v <- voom(dge, design, plot = TRUE)
dev.off()

# MA Plot
voom_res$neg_log_pval <- -log10(voom_res$P.Value)
ma_plot_voom <- ggplot(voom_res, aes(x = AveExpr, y = logFC, color = neg_log_pval)) +
  geom_point(alpha = 0.6) +
  scale_color_viridis_c(option = "viridis") +
  labs(
    x = "Average Expression",
    y = "Log Fold Change",
    color = "-Log10(P-Value)"
  )

# Save the plot to a file
ggsave(filename = "voom_MA_Plot.png", plot = ma_plot_voom, width = 10, dpi = 300)


# Batch-corrected PCA on top 1,000 most variable genes (voom)

# Apply removeBatchEffect to voom logCPM
voom_corrected <- removeBatchEffect(v$E, batch = meta$batch, covariates = meta$W_1)

# Identify top 1,000 most variable genes after correction
top_variable_genes_voom <- order(rowVars(voom_corrected), decreasing = TRUE)[1:1000]
voom_top_var_corrected <- voom_corrected[top_variable_genes_voom, ]

# Perform PCA
pca_results_voom <- prcomp(t(voom_top_var_corrected))
var_expl_voom <- summary(pca_results_voom)$importance[2, ]

# Prepare PCA scores
meta_df <- as.data.frame(meta) %>%
  rownames_to_column("sample")

pca_scores_voom <- data.frame(pca_results_voom$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")

# Add IDC classification
pca_scores_voom <- pca_scores_voom %>%
  select(-c(celltype, schizont, ring, trophozoite)) %>%
  left_join(idc_df, by = c("sample" = "sample_id"))

attr(pca_scores_voom, "var_expl") <- var_expl_voom

# Plot
plot_pca_pairs(pca_scores_voom, color_var = "group", tool_label = "voom_top_1000_batch_corrected", color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
plot_pca_pairs(pca_scores_voom, color_var = "cluster", tool_label = "voom_top_1000_batch_corrected", color_scheme = c("Mf" = "#440154FF", "Mn" = "#55C667FF"))
plot_pca_pairs(pca_scores_voom, color_var = "batch", tool_label = "voom_top_1000_batch_corrected", color_scheme = c("batch_1" = "#440154FF", "batch_2" = "#55C667FF"))
plot_pca_pairs(pca_scores_voom, color_var = "celltype", tool_label = "voom_top_1000_batch_corrected", color_scheme = c("trophozoite" = "#440154FF", "schizont" = "#55C667FF", "ring" = "#FDE725"))


# Pf IDC for voom

idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores_voom <- pca_scores_voom %>% 
  select(-any_of(c("celltype", "schizont", "ring", "trophozoite"))) %>%
  left_join(idc_df, by = c("sample" = "sample_id"))

plot_pca_pairs(pca_scores_voom, color_var = "celltype", tool_label = "voom_pf_1000_batch_corrected", 
  color_scheme = c("trophozoite" = "#440154FF", 
                   "schizont" = "#55C667FF", 
                   "ring" = "black", 
                   "gametocyte_female" = "#3B528BFF", 
                   "gametocyte_developing" = "#21908CFF", 
                   "gametocyte_male" = "#FDE725FF"))

# PCA on all genes with batch correction (voom)

# Apply removeBatchEffect across all genes
voom_corrected_all <- removeBatchEffect(v$E, batch = meta$batch, covariates = meta$W_1)

# PCA
pca_results_all <- prcomp(t(voom_corrected_all))
var_expl_all <- summary(pca_results_all)$importance[2, ]

# Prepare PCA scores
pca_scores_all <- data.frame(pca_results_all$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")


attr(pca_scores_all, "var_expl") <- var_expl_all

# Plot
plot_pca_pairs(pca_scores_all, color_var = "group", tool_label = "voom_batch_corrected_group", 
  color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))


# Batch correction on significant genes (voom)
# Subset significant genes
sig_genes_voom <- voom_res_df %>%
  filter(!is.na(adj.P.Val), adj.P.Val < 0.05, abs(logFC) > 1) %>%
  pull(gene)

# Expression matrix of significant genes
voom_sig <- v$E[sig_genes_voom, ]

# Apply batch correction
voom_sig_corrected <- removeBatchEffect(voom_sig,
  batch = meta$batch,
  covariates = meta$W_1
)

# PCA
pca_results_sig_corrected <- prcomp(t(voom_sig_corrected))
var_expl <- summary(pca_results_sig_corrected)$importance[2, ]

# Prepare scores
pca_scores_sig_corrected <- data.frame(pca_results_sig_corrected$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")

attr(pca_scores_sig_corrected, "var_expl") <- var_expl

# Plot
plot_pca_pairs(pca_scores_sig_corrected,
               color_var = "group",
               tool_label = "voom_sig_batch_corrected",
               color_scheme = c("Um" = "#440154FF", "Sm" = "#55C667FF"))


#####################################################



# Discordance/concordance

# DESeq2 significant genes
sig_deseq2 <- res_df %>%
  filter(!is.na(padj), padj < 0.05, abs(log2FoldChange) > 1) %>%
  select(gene, padj, log2FoldChange) %>%
  dplyr::rename(padj_deseq2 = padj, logFC_deseq2 = log2FoldChange)

# edgeR significant genes
sig_edger <- res_edgeR %>%
  rownames_to_column("gene") %>%
  filter(!is.na(FDR), FDR < 0.05, abs(logFC) > 1) %>%
  select(gene, FDR, logFC) %>%
  dplyr::rename(padj_edger = FDR, logFC_edger = logFC)

# voom significant genes
sig_voom <- voom_res_df %>%
  filter(!is.na(adj.P.Val), adj.P.Val < 0.05, abs(logFC) > 1) %>%
  select(gene, adj.P.Val, logFC) %>%
  dplyr::rename(padj_voom = adj.P.Val, logFC_voom = logFC)

# Save individually
write_tsv(sig_deseq2, "significant_genes_deseq2.tsv")
write_tsv(sig_edger,   "significant_genes_edger.tsv")
write_tsv(sig_voom,    "significant_genes_voom.tsv")

# Overlap (3-way)
overlap_all <- purrr::reduce(list(sig_deseq2, sig_edger, sig_voom), inner_join, by = "gene")
write_tsv(overlap_all, "significant_overlap_all_methods.tsv")

# Pairwise overlaps
overlap_deseq2_edger <- inner_join(sig_deseq2, sig_edger, by = "gene")
overlap_deseq2_voom  <- inner_join(sig_deseq2, sig_voom,  by = "gene")
overlap_edger_voom   <- inner_join(sig_edger,  sig_voom,  by = "gene")

# Summary
overlap_summary <- tibble(
  Sig_DESeq2  = nrow(sig_deseq2),
  Sig_edgeR   = nrow(sig_edger),
  Sig_voom    = nrow(sig_voom),
  Shared_all  = nrow(overlap_all),
  DESeq2_only = nrow(sig_deseq2) - nrow(bind_rows(overlap_deseq2_edger, overlap_deseq2_voom) %>% distinct(gene)),
  edgeR_only  = nrow(sig_edger)  - nrow(bind_rows(overlap_deseq2_edger, overlap_edger_voom) %>% distinct(gene)),
  voom_only   = nrow(sig_voom)   - nrow(bind_rows(overlap_deseq2_voom, overlap_edger_voom) %>% distinct(gene))
)

write_tsv(overlap_summary, "significant_overlap_summary.tsv")
print(overlap_summary)

# LFC vs LFC
# Extract and align LFCs
lfc_deseq2 <- res_df %>%
  select(log2FoldChange) %>%
  rownames_to_column("gene") %>%
  dplyr::rename(LFC_deseq2 = log2FoldChange)

lfc_edger <- res_edgeR %>%
  select(logFC) %>%
  rownames_to_column("gene") %>%
  dplyr::rename(LFC_edgeR = logFC)

lfc_voom <- voom_res_df %>%
  select(logFC) %>%
  rownames_to_column("gene") %>%
  dplyr::rename(LFC_voom = logFC)

# Merge all into one dataframe
lfc_merged <- purrr::reduce(list(lfc_deseq2, lfc_edger, lfc_voom), full_join, by = "gene") %>%
  drop_na()

# Create each plot
plot1 <- ggplot(lfc_merged, aes(x = LFC_deseq2, y = LFC_edgeR)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(title = "DESeq2 vs edgeR", x = "DESeq2 LFC", y = "edgeR LFC")

plot2 <- ggplot(lfc_merged, aes(x = LFC_deseq2, y = LFC_voom)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(title = "DESeq2 vs voom", x = "DESeq2 LFC", y = "voom LFC")

plot3 <- ggplot(lfc_merged, aes(x = LFC_edgeR, y = LFC_voom)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(title = "edgeR vs voom", x = "edgeR LFC", y = "voom LFC")

# Combine plots
combined_plot <- (plot1 | plot2) / plot3 +
  plot_annotation(title = "Log2 Fold Change Concordance Between Methods")

# Save as PNG
ggsave("lfc_concordance_all_methods.png", plot = combined_plot, width = 12, height = 10, dpi = 300)



####################################################

# Post analysis filtering


# Extract the count matrix and sample metadata
counts_matrix <- assay(summarised_de_filter)
sample_metadata <- colData(summarised_de_filter) %>% as.data.frame()

# Check if 'group' column exists in sample_metadata
if (!"group" %in% colnames(sample_metadata)) {
  stop("The 'group' column is not present in the sample metadata.")
}

# Initialize vectors to store counts and proportions
# overlap_all <- read_tsv("significant_overlap_all_methods.tsv")
num_nonzero_Sm <- integer(nrow(overlap_all))
num_nonzero_Um <- integer(nrow(overlap_all))
prop_nonzero_Sm <- numeric(nrow(overlap_all))
prop_nonzero_Um <- numeric(nrow(overlap_all))

# Total number of samples in each group
total_Sm <- sum(sample_metadata$group == "Sm")
total_Um <- sum(sample_metadata$group == "Um")

# Loop through each gene to calculate counts and proportions
for (i in seq_len(nrow(overlap_all))) {
  gene <- overlap_all$gene[i]
  
  if (gene %in% rownames(counts_matrix)) {
    gene_counts <- counts_matrix[gene, ]
    non_zero_samples <- gene_counts > 10
    
    # Count non-zero samples in each group
    num_nonzero_Sm[i] <- sum(non_zero_samples & sample_metadata$group == "Sm")
    num_nonzero_Um[i] <- sum(non_zero_samples & sample_metadata$group == "Um")
    
    # Calculate proportions
    prop_nonzero_Sm[i] <- num_nonzero_Sm[i] / total_Sm
    prop_nonzero_Um[i] <- num_nonzero_Um[i] / total_Um
  } else {
    # Assign NA if gene is not found in the counts matrix
    num_nonzero_Sm[i] <- NA
    num_nonzero_Um[i] <- NA
    prop_nonzero_Sm[i] <- NA
    prop_nonzero_Um[i] <- NA
  }
}

# Add these counts to the overlap_all data frame
overlap_all_sample_counts <- overlap_all %>%
  mutate(num_nonzero_Sm = num_nonzero_Sm,
         num_nonzero_Um = num_nonzero_Um,
         prop_nonzero_Sm = prop_nonzero_Sm,
         prop_nonzero_Um = prop_nonzero_Um) %>%
         arrange(desc(prop_nonzero_Sm), desc(prop_nonzero_Um))

# Save the updated data frame to a TSV file
write_tsv(overlap_all_sample_counts, "significant_overlap_with_nonzero_counts.tsv")

# Filter the genes based on >= 30% in both groups
overlap_all_sample_counts %>% 
  mutate(parent = str_remove(gene, "_i.*")) %>%
  relocate(parent, .after = gene) %>%
  filter(prop_nonzero_Um >= 0.3 & prop_nonzero_Sm >= 0.3) %>%
  write_tsv("significant_overlap_with_nonzero_counts_30_cutoff.tsv")

# Filter the genes based on >= 50% in both groups
overlap_all_sample_counts %>% 
  mutate(parent = str_remove(gene, "_i.*")) %>%
  relocate(parent, .after = gene) %>%
  filter(prop_nonzero_Um >= 0.5 & prop_nonzero_Sm >= 0.5) %>%
  write_tsv("significant_overlap_with_nonzero_counts_50_cutoff.tsv")

# Filter the genes based on >= 70% in both groups
overlap_all_sample_counts %>% 
  mutate(parent = str_remove(gene, "_i.*")) %>%
  relocate(parent, .after = gene) %>%
  filter(prop_nonzero_Um >= 0.7 & prop_nonzero_Sm >= 0.7) %>%
  write_tsv("significant_overlap_with_nonzero_counts_70_cutoff.tsv")

# Isoforms that come up > 1
overlap_all_sample_counts %>% 
  mutate(parent = str_remove(gene, "_i.*")) %>%
  relocate(parent, .after = gene) %>%
  filter(prop_nonzero_Um >= 0.3 & prop_nonzero_Sm >= 0.3) %>%
  group_by(parent) %>%
  filter(n() > 1) %>%  # keep only parents that appear in >1 row
  ungroup() %>%
  write_tsv("significant_overlap_with_nonzero_counts_30_cutoff_multiple_iso.tsv")
```

# Discordance of significant genes within tools across filters

## run in ./analyses

```{R,eval=F}
library(tidyverse)
library(UpSetR)

# Define a helper function to extract sig genes from full results
extract_sig_genes <- function(path, method = c("deseq2", "edgeR", "voom")) {
  method <- match.arg(method)

  df <- read_tsv(file.path(path, paste0(method, "_results_full.tsv")))

  if (method == "deseq2") {
    df %>%
      filter(!is.na(padj), padj < 0.001, abs(log2FoldChange) > 1) %>%
      pull(gene)
  } else if (method == "edgeR") {
    df %>%
      filter(!is.na(FDR), FDR < 0.001, abs(logFC) > 1) %>%
      pull(gene)
  } else if (method == "voom") {
    df %>%
      filter(!is.na(adj.P.Val), adj.P.Val < 0.01, abs(logFC) > 1) %>%
      pull(gene)
  }
}

# DESeq2
sig_deseq2_10 <- extract_sig_genes("custom_1cpm_10_samples_ruv", method = "deseq2")
sig_deseq2_20 <- extract_sig_genes("custom_1cpm_20_samples_ruv", method = "deseq2")
sig_deseq2_107 <- extract_sig_genes("custom_1cpm_107_samples_ruv", method = "deseq2")

# edgeR
sig_edger_10 <- extract_sig_genes("custom_1cpm_10_samples_ruv", method = "edgeR")
sig_edger_20 <- extract_sig_genes("custom_1cpm_20_samples_ruv", method = "edgeR")
sig_edger_107 <- extract_sig_genes("custom_1cpm_107_samples_ruv", method = "edgeR")

# voom
sig_voom_10 <- extract_sig_genes("custom_1cpm_10_samples_ruv", method = "voom")
sig_voom_20 <- extract_sig_genes("custom_1cpm_20_samples_ruv", method = "voom")
sig_voom_107 <- extract_sig_genes("custom_1cpm_107_samples_ruv", method = "voom")

# DESeq2
sets_deseq2 <- list(
  `10 samples` = sig_deseq2_10,
  `20 samples` = sig_deseq2_20,
  `107 samples` = sig_deseq2_107
)

upset_input_deseq2 <- fromList(sets_deseq2)

png("diagnostic_plots/upset_deseq2_sample_counts.png", width = 2500, height = 1800, res = 300)
upset(upset_input_deseq2,
       sets = c("10 samples", "20 samples", "107 samples"),
       keep.order = TRUE,
       order.by = "freq",
       mainbar.y.label = "DESeq2 DE Genes")
dev.off()

# edgeR
sets_edger <- list(
  `10 samples` = sig_edger_10,
  `20 samples` = sig_edger_20,
  `107 samples` = sig_edger_107
)

upset_input_edger <- fromList(sets_edger)

png("diagnostic_plots/upset_edger_sample_counts.png", width = 2500, height = 1800, res = 300)
upset(upset_input_edger,
       sets = c("10 samples", "20 samples", "107 samples"),
       keep.order = TRUE,
       order.by = "freq",
       mainbar.y.label = "edgeR DE Genes")
dev.off()

# voom
sets_voom <- list(
  `10 samples` = sig_voom_10,
  `20 samples` = sig_voom_20,
  `107 samples` = sig_voom_107
)

upset_input_voom <- fromList(sets_voom)

png("diagnostic_plots/upset_voom_sample_counts.png", width = 2500, height = 1800, res = 300)
upset(upset_input_voom,
       sets = c("10 samples", "20 samples", "107 samples"),
       keep.order = TRUE,
       order.by = "freq",
       mainbar.y.label = "voom DE Genes")
dev.off()
```


# Comparing VOOM weights across models - same filters but different formula (covar)

## Run in ./analyses

```{R,eval=F}
library(tidyverse)

# Load weights
weights_simple <- readRDS("custom_1cpm_64_samples/voom_weights.rds")
weights_covar  <- readRDS("custom_1cpm_64_samples_covar/voom_weights.rds")

# Calculate mean precision weight per gene (rows)
mean_weights_simple <- rowMeans(weights_simple)
mean_weights_covar  <- rowMeans(weights_covar)

# Merge and prepare for plotting
weights_df <- tibble(
  gene = rownames(weights_simple),
  simple_model = mean_weights_simple,
  covar_model = mean_weights_covar
)

# Plot
ggplot(weights_df, aes(x = simple_model, y = covar_model)) +
  geom_point(alpha = 0.3) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Mean Voom Weights: Simple vs Covariate Models",
    x = "Mean Voom Weight (Simple Model)",
    y = "Mean Voom Weight (Covariate Model)"
  ) 

ggsave("diagnostic_plots/compare_voom_weights_scatter_64.png", dpi = 300)
```


############################################################

# Annotation

# Annotating significant genes with annotated genome (PKA1H1) 

## Using Pk genome

```{R,eval=F}
#!/bin/bash
#PBS -P pq84
#PBS -q normalbw
#PBS -N genome_annotation
#PBS -j oe
#PBS -m ae
#PBS -l walltime=48:00:00,mem=80GB,ncpus=10
#PBS -l storage=gdata/pq84+scratch/pq84
#PBS -M jacob.westaway@menzies.edu.au

echo "---------------------------------------"
echo "PBS: Job identifier is $PBS_JOBID"
echo "PBS: Job name is $PBS_JOBNAME"

echo "---------------------------------------"
echo "Source env modules and paths"
cd /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/
source /g/data/pq84/malaria/boxes/annotating_transcripts/bin/activate
mkdir -p output/genome_annotation

echo "---------------------------------------"
echo "Run gmap - index"
gmap_build -d PlasmoDB-67_PknowlesiA1H1_Genome -D output/genome_annotation/gmap_index -k 15 /g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/data/ref_genomes/PKA1H1/fasta/PlasmoDB_version/PlasmoDB-67_PknowlesiA1H1_Genome.fasta

echo "---------------------------------------"
echo "Run gmap - align"
gmap -d PlasmoDB-67_PknowlesiA1H1_Genome -D output/genome_annotation/gmap_index \
     -f gff3_gene --npaths=1 output/trinity_assembly/trinity_assembly_unique.Trinity.fasta \
     > output/genome_annotation/Trinity2.gmap.gff3

echo "---------------------------------------"
echo "Extract gene information"
cd output/genome_annotation
gffread Trinity2.gmap.gff3 -T -o Trinity.gtf

echo "---------------------------------------"
echo "Convert refrerence gff to gtf"
gffread /g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/data/ref_genomes/PKA1H1/fasta/PlasmoDB_version/PlasmoDB-68_PknowlesiA1H1.gff -T -o PlasmoDB-68_PknowlesiA1H1.gtf

echo "---------------------------------------"
echo "Get gene names"
gffcompare -r PlasmoDB-68_PknowlesiA1H1.gtf -o Trinity_annot Trinity.gtf

echo "---------------------------------------"
echo "Finished"
```

```{R,eval=F}
library(tidyverse)
library(rtracklayer)
library(purrr)

gff <- import("/g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/data/ref_genomes/PKA1H1/fasta/PlasmoDB_version/PlasmoDB-68_PknowlesiA1H1.gff")

gene_annots <- as.data.frame(gff[gff$type == "gene", c("ID", "Name", "description")])

gtf <- import("Trinity_annot.annotated.gtf")

# Filter to features with usable descriptions or names
gff_annots <- gff[!is.na(gff$description) | !is.na(gff$Name)]

# Extract metadata into a data frame
gff_metadata <- as.data.frame(mcols(gff_annots)) %>%
  select(ID, Name, description, ebi_biotype) %>%
  distinct() %>%
  distinct(ID, .keep_all = TRUE)

gtf_df <- as.data.frame(mcols(gtf))

# Merge description, gene name, and biotype
gtf_annot_df <- gtf_df %>%
  left_join(gff_metadata, by = c("ref_gene_id" = "ID"))

# Replace metadata in GRanges
mcols(gtf) <- gtf_annot_df

# Helper function to collapse attributes into GTF-format string
gtf_attributes <- function(gene_id, transcript_id, xloc = NA, class_code = NA, tss_id = NA,
                           exon_number = NA, description = NA, Name = NA, ebi_biotype = NA, ...) {
  fields <- c(
    paste0('gene_id "', gene_id, '"'),
    paste0('transcript_id "', transcript_id, '"'),
    if (!is.na(xloc)) paste0('xloc "', xloc, '"'),
    if (!is.na(class_code)) paste0('class_code "', class_code, '"'),
    if (!is.na(tss_id)) paste0('tss_id "', tss_id, '"'),
    if (!is.na(exon_number)) paste0('exon_number "', exon_number, '"'),
    if (!is.na(description)) paste0('description "', description, '"'),
    if (!is.na(Name)) paste0('gene_name "', Name, '"'),
    if (!is.na(ebi_biotype)) paste0('gene_biotype "', ebi_biotype, '"')
  )
  paste(fields, collapse = "; ")
}

# Apply to your GTF GRanges
mcols(gtf)$attribute <- pmap_chr(as.data.frame(mcols(gtf)), gtf_attributes)

# Remove other columns to clean up
mcols(gtf) <- mcols(gtf)[, "attribute", drop = FALSE]

# Export GTF
export(gtf, "Trinity_annot_with_full_annotations.gtf", format = "gtf")
```


## Combine annotation and significant genes

### Ran the annotation with filtered data and full DE list - sub significant_overlap_all_methods.tsv with significant_overlap_with_nonzero_counts_30_cutoff.tsv (count of 10 and 30% of each group)
## For iso, we focused on multiple isoform genes - significant_overlap_with_nonzero_counts_30_cutoff_multiple_iso.tsv

```{bash,eval=F}
cd /g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv/nonzero_counts_30
awk '{print $1}' significant_overlap_with_nonzero_counts_30_cutoff.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/output/genome_annotation/Trinity_annot_with_full_annotations.gtf > significant_genes_annotation.txt
grep 'description' significant_genes_annotation.txt > significant_genes_description.txt
```

```{R,eval=F}
library(tidyverse)

# Read in the DE results
de_results <- read_tsv("significant_overlap_with_nonzero_counts_30_cutoff.tsv")

# Read in the description file
desc_raw <- read_tsv("significant_genes_description.txt", col_names = FALSE)

# Extract gene_id and description from the 9th column (attributes)
desc_clean <- desc_raw %>%
  select(X9) %>%
  mutate(
    gene = str_extract(X9, 'gene_id\\s+\\"(TRINITY[^"]+)') %>% str_remove('gene_id\\s+\\"'),
    description = str_extract(X9, 'description\\s+\\"([^"]+)') %>% str_remove('description\\s+\\"')
  ) %>%
  select(gene, description) %>%
  mutate(gene = str_remove(gene, "_i.*")) %>%
  distinct()  # remove duplicate entries for the same gene

# Join with DE results
de_with_desc <- de_results %>%
  left_join(desc_clean, by = "gene")  

write_tsv(de_with_desc, "significant_genes_with_description.tsv")
```


# Annotating significant genes using de novo annotation (Trinotate)

## De novo annotation 
Look at /g/data/pq84/malaria/Pk_trancsriptomics/scripts/Trinotate.Rmd to generate annotations (trinity_assembly_unique.Trinotate.tsv)


## Combine annotation and significant genes (from both reference genome method and de novo method)

```{bash,eval=F}
awk '{print $1}' significant_overlap_with_nonzero_counts_30_cutoff.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique_non_cod.Trinotate.tsv | 
cat <(head -n 1 /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique.Trinotate.tsv) - \
> significant_genes_annotation_trinotate.txt
```

### Generate a file with biological descriptions for Infernal 'genes'

```{bash,eval=F}
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/infernal_combined.out > infernal_descriptions_sig_genes.txt
```

```{R,eval=F}
library(tidyverse)

genome_data <- read_tsv("significant_genes_with_description.tsv") %>%
  dplyr::rename(PKA1H1_description = description) 

trinotate <- read_tsv("significant_genes_annotation_trinotate.txt", na = c(".", "")) %>%
  dplyr::rename(gene = `#gene_id`) %>%
  arrange(
    gene,
    desc(!is.na(sprot_Top_BLASTX_hit)),
    desc(!is.na(sprot_Top_BLASTP_hit)),
    desc(!is.na(Pfam)),
    desc(!is.na(SignalP)),
    desc(!is.na(TmHMM)),
    desc(!is.na(Kegg))
  )

# merge data
merged_anno <- trinotate %>%
  group_by(gene) %>%
  summarise(
    transcript_ids = paste(unique(transcript_id), collapse = ","),
    across(
      -transcript_id,
      ~ {
        vals <- unique(na.omit(.x))
        if (length(vals) == 0) NA_character_ else if (length(vals) == 1) vals else paste(vals, collapse = ",")
      }
    ),
    .groups = "drop"
  ) %>%
  left_join(genome_data) %>%
  relocate(gene, PKA1H1_description) %>%
  relocate(transcript_ids, .after = last_col()) %>%
  arrange(padj_voom) %>%
  mutate(
    sprot_Top_BLASTX_hit = str_remove(sprot_Top_BLASTX_hit, ".*Full="),
    sprot_Top_BLASTX_hit = str_remove(sprot_Top_BLASTX_hit, ";.*"),
    sprot_Top_BLASTP_hit = str_remove(sprot_Top_BLASTP_hit, ".*Full="),
    sprot_Top_BLASTP_hit = str_remove(sprot_Top_BLASTP_hit, ";.*"),
    
    # Extract all Rfam model names from the infernal column
    infernal = ifelse(
      is.na(infernal),
      NA,
      infernal %>%
        str_split("`") %>%
        map_chr(~ paste0(unique(str_extract(.x, "^[^\\^]+")), collapse = ","))
    )
  ) %>%
  mutate(across(where(is.character), ~ na_if(.x, "")))

merged_anno %>%
  write_tsv("significant_genes_description_combined.tsv")

merged_anno %>%
  mutate(
    description = case_when(
      !is.na(PKA1H1_description) ~ PKA1H1_description,
      !is.na(sprot_Top_BLASTX_hit) ~ sprot_Top_BLASTX_hit,
      !is.na(sprot_Top_BLASTP_hit) ~ sprot_Top_BLASTP_hit,
      !is.na(infernal) ~ infernal,
      TRUE ~ NA_character_
    ),
    description_source = case_when(
      !is.na(PKA1H1_description) ~ "PKA1H1",
      !is.na(sprot_Top_BLASTX_hit) ~ "BLASTX",
      !is.na(sprot_Top_BLASTP_hit) ~ "BLASTP",
      !is.na(infernal) ~ "Infernal",
      TRUE ~ NA_character_
    ),
    higher_expression = case_when(
      is.na(logFC_voom) ~ NA_character_,
      logFC_voom < 0 ~ "Um",
      logFC_voom > 0 ~ "Sm",
      TRUE ~ "No change"
    )
  ) %>%
  select(
    gene,
    description,
    description_source,
    padj_voom,
    logFC_voom,
    higher_expression
  ) %>%
  #mutate(padj_voom = round(padj_voom, 3)) %>%
  arrange(desc(!is.na(description))) %>%
  write_tsv("significant_genes_description_combined_brief.tsv")
```


# Look at distribution of significant genes across IDC and test for associations between CPM and IDC proportions

Run in:de_covar/custom_1cpm_10_samples_ruv

```{R,eval=F}
library(tidyverse)
library(edgeR)  # for CPM calculation
library(SummarizedExperiment)
library(broom)

# Load everything
summarised_de <- readRDS("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/summarised_de.rds")
signif_genes <- read_tsv("significant_overlap_all_methods.tsv") %>% pull(gene)

# Combine IDC and metadata
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  left_join(
      read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt")
  ) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) %>%
  mutate(schizont = schizont * 100,
    ring = ring * 100,
    trophozoite = trophozoite * 100)

meta_idc_combined <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/full_meta_for_de.tsv") %>%
  dplyr::rename(sample = file) %>%
  mutate(sample_id = str_remove(sample, ".txt")) %>%
  left_join(
    idc_df,
    by = "sample_id"
  )

idc_pf_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) %>%
  rename_with(.cols = -sample_id, .fn = ~ paste0("pf_", .x))

meta_idc_combined <- meta_idc_combined %>%
  left_join(idc_pf_df, by = "sample_id")

# Extract counts
counts_mat <- assays(summarised_de)[["counts"]]

# Calculate CPMs
cpm_mat <- cpm(counts_mat, log = FALSE) # raw CPM, not log-CPM

# Prepare CPM dataframe
cpm_df <- as.data.frame(cpm_mat) %>%
  rownames_to_column(var = "gene")

# Remove '.txt' from column names to match sample IDs
colnames(cpm_df) <- gsub("\\.txt$", "", colnames(cpm_df))

# Filter to significant genes
cpm_signif <- cpm_df %>%
  filter(gene %in% signif_genes)

# Pivot longer
cpm_long <- cpm_signif %>%
  pivot_longer(
    cols = -gene,
    names_to = "sample_id",
    values_to = "cpm"
  )

# Join with IDC proportions and metadata
summary_df <- cpm_long %>%
  left_join(meta_idc_combined, by = "sample_id") %>%
  select(
    gene,
    sample_id,
    cpm,
    schizont, ring, trophozoite,    # from Knowlesi
    pf_schizont, pf_ring, pf_trophozoite, # from Pf
    everything()
  ) %>%
  mutate(logCPM = log2(cpm + 1)) %>%
  mutate(
    # Knowlesi dominant stage (still 3 stages)
    dominant_idc_pk = pmap_chr(
      list(schizont, ring, trophozoite),
      ~ c("schizont", "ring", "trophozoite")[which.max(c(...))]
    ),
    # Pf dominant stage (now 5 stages)
    dominant_idc_pf = pmap_chr(
      list(
        pf_gametocyte_developing,
        pf_gametocyte_female,
        pf_gametocyte_male,
        pf_ring,
        pf_schizont,
        pf_trophozoite
      ),
      ~ c(
        "pf_gametocyte_developing",
        "pf_gametocyte_female",
        "pf_gametocyte_male",
        "pf_ring",
        "pf_schizont",
        "pf_trophozoite"
      )[which.max(c(...))]
    )
  )

# Test for association with each gene and IDC

# Association between severity and life stage?
# Or for all IDC stages at once:
idc_columns <- c("schizont", "ring", "trophozoite", "pf_gametocyte_developing", 
  "pf_gametocyte_female", "pf_gametocyte_male", "pf_ring", "pf_schizont", "pf_trophozoite")

idc_columns %>% 
  set_names() %>% 
  map(~ wilcox.test(reformulate("sevemal", .x), data = meta_idc_combined) %>% broom::tidy())


# Spearman correlation on logCPM
correlate_one_gene_log <- function(df) {
  df_filtered <- df %>% 
    filter(cpm > 0) %>%
    mutate(pf_gametocyte_total = pf_gametocyte_developing + pf_gametocyte_female + pf_gametocyte_male)

  if (nrow(df_filtered) < 5) return(tibble())  # skip genes with too few expressed samples

  tibble(
    schizont = cor.test(df_filtered$logCPM, df_filtered$schizont, method = "spearman") %>% tidy(),
    ring = cor.test(df_filtered$logCPM, df_filtered$ring, method = "spearman") %>% tidy(),
    trophozoite = cor.test(df_filtered$logCPM, df_filtered$trophozoite, method = "spearman") %>% tidy(),
    pf_ring = cor.test(df_filtered$logCPM, df_filtered$pf_ring, method = "spearman") %>% tidy(),
    pf_schizont = cor.test(df_filtered$logCPM, df_filtered$pf_schizont, method = "spearman") %>% tidy(),
    pf_trophozoite = cor.test(df_filtered$logCPM, df_filtered$pf_trophozoite, method = "spearman") %>% tidy(),
    pf_gametocyte_developing = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_developing, method = "spearman") %>% tidy(),
    pf_gametocyte_female = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_female, method = "spearman") %>% tidy(),
    pf_gametocyte_male = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_male, method = "spearman") %>% tidy(),
    pf_gametocyte_total = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_total, method = "spearman") %>% tidy()
  ) %>%
    pivot_longer(cols = everything(), names_to = "life_stage", values_to = "cor_test") %>%
    unnest_wider(cor_test)
}

# Run across genes
cor_results_log <- summary_df %>%
  group_by(gene) %>%
  group_modify(~ correlate_one_gene_log(.x)) %>%
  ungroup()

# Adjust p-values
cor_results_log <- cor_results_log %>%
  mutate(p_adj = p.adjust(p.value, method = "BH"))

# Apply strict filter: p_adj < 0.05 and abs(rho) > 0.5
top_hits_strict <- cor_results_log %>%
  filter(p_adj < 0.01, abs(estimate) > 0.5) %>%
  arrange(p_adj)

# How many genes are associated with life stage?
top_hits_strict %>% 
  select(gene) %>% 
  unique() %>%
  nrow()

# How many genes are associated with each life stage?
top_hits_strict %>%
  mutate(life_stage_chr = map_chr(life_stage, as.character)) %>%
  group_by(life_stage_chr) %>%
  summarise(n_genes = n(), .groups = "drop") %>%
  arrange(desc(n_genes))

# Plot top genes vs life stage
#Get top 5 strongest associations by absolute rho (correlation)
top5_hits <- top_hits_strict %>%
  arrange(p_adj, desc(abs(estimate))) %>%
  dplyr::slice(1:5)

summary_df <- summary_df %>%
  mutate(pf_gametocyte_total = pf_gametocyte_developing + pf_gametocyte_female + pf_gametocyte_male)

# Plot logCPM vs life stage proportion for each top gene
plot_list <- top5_hits %>%
  mutate(plot = pmap(
    list(gene, life_stage),
    function(g, stage) {
      summary_df %>%
        filter(gene == g) %>%
        ggplot(aes_string(x = stage, y = "logCPM")) +
        geom_point(alpha = 0.7) +
        geom_smooth(method = "lm", se = FALSE, color = "steelblue") +
        labs(
          title = paste("Gene:", g),
          subtitle = paste("Life stage:", stage),
          x = stage,
          y = "logCPM"
        )
    }
  ))

# Print the plots
walk2(
  plot_list$plot,
  paste0("log_vs_cpm/logCPM_vs_", plot_list$life_stage, "_", plot_list$gene, ".png"),
  ~ ggsave(filename = .y, plot = .x, width = 6, height = 4, units = "in")
)


# Add biology annotation to all hits
desc_raw <- read_tsv("significant_genes_description.txt", 
                     col_names = FALSE, comment = "#", quote = "") 

desc_df <- desc_raw %>%
  mutate(
    gene_id = str_extract(X9, 'gene_id \\"[^"]+\\"') %>% str_remove_all('gene_id \\"|\\"'),
    description = str_extract(X9, 'description \\"[^"]+\\"') %>% str_remove_all('description \\"|\\"')
  ) %>%
  select(gene_id, description) %>%
  distinct(gene_id, .keep_all = TRUE) %>%
  mutate(gene_id = str_remove(gene_id, "_i.*")) %>%
  unique()

top_hits_strict_annotated <- top_hits_strict %>%
  left_join(desc_df, by = c("gene" = "gene_id"))

write_tsv(top_hits_strict_annotated, "spearmen_idc_cpm_from_sig_de.txt")
```

# Add information on isoform completeness to significant genes

```{R,eval=F}
library(tidyverse)

sig_genes <- read_tsv("nonzero_counts_30_ruv/significant_genes_description_combined.tsv") 

length <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/trinity_assembly_unique_non_cod.Trinotate.with_full_length.tsv") %>%
  select(1, 2, "full_length")  %>%
  filter(`#gene_id` %in% sig_genes$gene) 

genes_with_full_length <- length %>%
  group_by(`#gene_id`) %>%
  summarise(any_full_length = any(full_length), .groups = "drop") %>%
  rename(gene = `#gene_id`) 

sig_genes %>%
  left_join(
    genes_with_full_length
  ) %>%
  write_tsv("nonzero_counts_30_ruv/significant_genes_description_combined_isoform_length.tsv")

read_tsv("nonzero_counts_30_ruv/significant_genes_description_combined_brief.tsv") %>%
  left_join(
    genes_with_full_length
  ) %>%
  write_tsv("nonzero_counts_30_ruv/significant_genes_description_combined_brief_isoform_length.tsv")
```

############################################################################

# Annotating significant genes with annotated genome (PKA1H1) 

## Combine annotation and significant isoforms


```{bash,eval=F}
cd /g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv_iso
awk '{print $1}' significant_overlap_all_methods.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/output/genome_annotation/Trinity_annot_with_full_annotations.gtf > significant_genes_annotation.txt
grep 'description' significant_genes_annotation.txt > significant_genes_description.txt
```

```{R,eval=F}
library(tidyverse)

# Read in the DE results
de_results <- read_tsv("significant_overlap_all_methods.tsv")

# Read in the description file
desc_raw <- read_tsv("significant_genes_description.txt", col_names = FALSE)

# Extract gene_id and description from the 9th column (attributes)
desc_clean <- desc_raw %>%
  select(X9) %>%
  mutate(
    gene = str_extract(X9, 'transcript_id\\s+\\"(TRINITY[^"]+)') %>% str_remove('transcript_id\\s+\\"'),
    description = str_extract(X9, 'description\\s+\\"([^"]+)') %>% str_remove('description\\s+\\"')
  ) %>%
  select(gene, description) %>%
  mutate(gene = str_remove(gene, "\\..*")) %>%
  distinct()  # remove duplicate entries for the same gene

# Join with DE results
de_with_desc <- de_results %>%
  left_join(desc_clean, by = "gene")  

write_tsv(de_with_desc, "significant_genes_with_description.tsv")
```


# Annotating significant genes using de novo annotation (Trinotate)

## De novo annotation 
Look at /g/data/pq84/malaria/Pk_trancsriptomics/scripts/Trinotate.Rmd to generate annotations (trinity_assembly_unique.Trinotate.tsv)


## Combine annotation and significant genes (from both reference genome method and de novo method)

```{bash,eval=F}
awk '{print $1}' significant_overlap_all_methods.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique_non_cod.Trinotate.tsv | 
cat <(head -n 1 /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique.Trinotate.tsv) - \
> significant_genes_annotation_trinotate.txt
```

### Generate a file with biological descriptions for Infernal 'genes'

```{bash,eval=F}
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/infernal_combined.out > infernal_descriptions_sig_genes.txt
```

```{R,eval=F}
library(tidyverse)

genome_data <- read_tsv("significant_genes_with_description.tsv") %>%
  rename(PKA1H1_description = description) 

trinotate <- read_tsv("significant_genes_annotation_trinotate.txt", na = c(".", "")) %>%
  rename(gene = transcript_id) %>%
  arrange(
    gene,
    desc(!is.na(sprot_Top_BLASTX_hit)),
    desc(!is.na(sprot_Top_BLASTP_hit)),
    desc(!is.na(Pfam)),
    desc(!is.na(SignalP)),
    desc(!is.na(TmHMM)),
    desc(!is.na(Kegg))
  )

# merged data
merged_anno <- trinotate %>% 
  left_join(genome_data, by = "gene") %>%
  relocate(gene, PKA1H1_description) %>%
  arrange(padj_voom) %>% 
  mutate(
    sprot_Top_BLASTX_hit = str_remove(sprot_Top_BLASTX_hit, ".*Full=") %>% str_remove(";.*"),
    sprot_Top_BLASTP_hit = str_remove(sprot_Top_BLASTP_hit, ".*Full=") %>% str_remove(";.*"),
    infernal = case_when(
      is.na(infernal) ~ NA_character_,
      TRUE ~ infernal %>%
        str_split("`") %>%
        map_chr(~ paste0(unique(str_extract(.x, "^[^\\^]+")), collapse = ","))
    ),
    across(where(is.character), ~ na_if(.x, ""))
  ) %>%
  select(-`#gene_id`) %>%
  filter(!is.na(padj_voom))

merged_anno %>%
  write_tsv("significant_genes_description_combined.tsv")

merged_anno %>%
  mutate(
    description = case_when(
      !is.na(PKA1H1_description) ~ as.character(PKA1H1_description),
      !is.na(sprot_Top_BLASTX_hit) ~ as.character(sprot_Top_BLASTX_hit),
      !is.na(sprot_Top_BLASTP_hit) ~ as.character(sprot_Top_BLASTP_hit),
      !is.na(infernal) ~ as.character(infernal),
      TRUE ~ NA_character_
    ),
    description_source = case_when(
      !is.na(PKA1H1_description) ~ "PKA1H1",
      !is.na(sprot_Top_BLASTX_hit) ~ "BLASTX",
      !is.na(sprot_Top_BLASTP_hit) ~ "BLASTP",
      !is.na(infernal) ~ "Infernal",
      TRUE ~ NA_character_
    ),
    higher_expression = case_when(
      is.na(logFC_voom) ~ NA_character_,
      logFC_voom < 0 ~ "Sm",
      logFC_voom > 0 ~ "Um",
      TRUE ~ "No change"
    )
  ) %>%
  select(
    gene,
    description,
    description_source,
    padj_voom,
    logFC_voom,
    higher_expression
  ) %>%
  #mutate(padj_voom = round(padj_voom, 3)) %>%
  arrange(desc(!is.na(description))) %>%
  arrange(description) %>%
  group_by(description) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  na.omit() %>%
  write_tsv("significant_genes_description_combined_brief.tsv")
```


# Look at distribution of significant genes across IDC and test for associations between CPM and IDC proportions

# Run in: /g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv

```{R,eval=F}
library(tidyverse)
library(edgeR)  # for CPM calculation
library(SummarizedExperiment)
library(broom)

# Load everything
summarised_de <- readRDS("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/summarised_de.rds")
signif_genes <- read_tsv("significant_overlap_all_methods.tsv") %>% pull(gene)
signif_genes <- read_tsv("significant_overlap_with_nonzero_counts_30_cutoff.tsv") %>% pull(gene)

# Combine IDC and metadata
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt") %>% 
  pivot_longer(cols = -sample_id, names_to = "celltype", values_to = "proportion") %>% 
  group_by(sample_id) %>%
  slice_max(order_by = proportion, n = 1) %>%
  ungroup() %>% 
  select(-proportion) %>%
  left_join(
      read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pk_ref/scaden_mean_proportions.txt")
  ) %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) %>%
  mutate(schizont = schizont * 100,
    ring = ring * 100,
    trophozoite = trophozoite * 100)

meta_idc_combined <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/full_meta_for_de.tsv") %>%
  dplyr::rename(sample = file) %>%
  mutate(sample_id = str_remove(sample, ".txt")) %>%
  left_join(
    idc_df,
    by = "sample_id"
  )

idc_pf_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>%
  mutate(sample_id = str_replace(sample_id, "-", "_")) %>%
  rename_with(.cols = -sample_id, .fn = ~ paste0("pf_", .x))

meta_idc_combined <- meta_idc_combined %>%
  left_join(idc_pf_df, by = "sample_id")

# Extract counts
counts_mat <- assays(summarised_de)[["counts"]]

# Calculate CPMs
cpm_mat <- cpm(counts_mat, log = FALSE) # raw CPM, not log-CPM

# Prepare CPM dataframe
cpm_df <- as.data.frame(cpm_mat) %>%
  rownames_to_column(var = "gene")

# Remove '.txt' from column names to match sample IDs
colnames(cpm_df) <- gsub("\\.txt$", "", colnames(cpm_df))

# Filter to significant genes
cpm_signif <- cpm_df %>%
  filter(gene %in% signif_genes)

# Pivot longer
cpm_long <- cpm_signif %>%
  pivot_longer(
    cols = -gene,
    names_to = "sample_id",
    values_to = "cpm"
  )

# Join with IDC proportions and metadata
summary_df <- cpm_long %>%
  left_join(meta_idc_combined, by = "sample_id") %>%
  select(
    gene,
    sample_id,
    cpm,
    schizont, ring, trophozoite,    # from Knowlesi
    pf_schizont, pf_ring, pf_trophozoite, # from Pf
    everything()
  ) %>%
  mutate(logCPM = log2(cpm + 1)) %>%
  mutate(
    # Knowlesi dominant stage (still 3 stages)
    dominant_idc_pk = pmap_chr(
      list(schizont, ring, trophozoite),
      ~ c("schizont", "ring", "trophozoite")[which.max(c(...))]
    ),
    # Pf dominant stage (now 5 stages)
    dominant_idc_pf = pmap_chr(
      list(
        pf_gametocyte_developing,
        pf_gametocyte_female,
        pf_gametocyte_male,
        pf_ring,
        pf_schizont,
        pf_trophozoite
      ),
      ~ c(
        "pf_gametocyte_developing",
        "pf_gametocyte_female",
        "pf_gametocyte_male",
        "pf_ring",
        "pf_schizont",
        "pf_trophozoite"
      )[which.max(c(...))]
    )
  )

# Test for association with each gene and IDC

# Association between severity and life stage?
# Or for all IDC stages at once:
idc_columns <- c("schizont", "ring", "trophozoite", "pf_gametocyte_developing", 
  "pf_gametocyte_female", "pf_gametocyte_male", "pf_ring", "pf_schizont", "pf_trophozoite")

idc_columns %>% 
  set_names() %>% 
  map(~ wilcox.test(reformulate("sevemal", .x), data = meta_idc_combined) %>% broom::tidy())


# Spearman correlation on logCPM
correlate_one_gene_log <- function(df) {
  df_filtered <- df %>% 
    filter(cpm > 0) %>%
    mutate(pf_gametocyte_total = pf_gametocyte_developing + pf_gametocyte_female + pf_gametocyte_male)

  if (nrow(df_filtered) < 5) return(tibble())  # skip genes with too few expressed samples

  tibble(
    schizont = cor.test(df_filtered$logCPM, df_filtered$schizont, method = "spearman") %>% tidy(),
    ring = cor.test(df_filtered$logCPM, df_filtered$ring, method = "spearman") %>% tidy(),
    trophozoite = cor.test(df_filtered$logCPM, df_filtered$trophozoite, method = "spearman") %>% tidy(),
    pf_ring = cor.test(df_filtered$logCPM, df_filtered$pf_ring, method = "spearman") %>% tidy(),
    pf_schizont = cor.test(df_filtered$logCPM, df_filtered$pf_schizont, method = "spearman") %>% tidy(),
    pf_trophozoite = cor.test(df_filtered$logCPM, df_filtered$pf_trophozoite, method = "spearman") %>% tidy(),
    pf_gametocyte_developing = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_developing, method = "spearman") %>% tidy(),
    pf_gametocyte_female = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_female, method = "spearman") %>% tidy(),
    pf_gametocyte_male = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_male, method = "spearman") %>% tidy(),
    pf_gametocyte_total = cor.test(df_filtered$logCPM, df_filtered$pf_gametocyte_total, method = "spearman") %>% tidy()
  ) %>%
    pivot_longer(cols = everything(), names_to = "life_stage", values_to = "cor_test") %>%
    unnest_wider(cor_test)
}

# Run across genes
cor_results_log <- summary_df %>%
  group_by(gene) %>%
  group_modify(~ correlate_one_gene_log(.x)) %>%
  ungroup()

# Adjust p-values
cor_results_log <- cor_results_log %>%
  mutate(p_adj = p.adjust(p.value, method = "BH"))

# Apply strict filter: p_adj < 0.05 and abs(rho) > 0.5
top_hits_strict <- cor_results_log %>%
  filter(p_adj < 0.01, abs(estimate) > 0.5) %>%
  arrange(p_adj)

# How many genes are associated with life stage?
top_hits_strict %>% 
  select(gene) %>% 
  unique() %>%
  nrow()

# How many genes are associated with each life stage?
top_hits_strict %>%
  mutate(life_stage_chr = map_chr(life_stage, as.character)) %>%
  group_by(life_stage_chr) %>%
  summarise(n_genes = n(), .groups = "drop") %>%
  arrange(desc(n_genes))

# Plot top genes vs life stage
#Get top 5 strongest associations by absolute rho (correlation)
top5_hits <- top_hits_strict %>%
  arrange(p_adj, desc(abs(estimate))) %>%
  dplyr::slice(1:5)

summary_df <- summary_df %>%
  mutate(pf_gametocyte_total = pf_gametocyte_developing + pf_gametocyte_female + pf_gametocyte_male)

# Plot logCPM vs life stage proportion for each top gene
plot_list <- top5_hits %>%
  mutate(plot = pmap(
    list(gene, life_stage),
    function(g, stage) {
      summary_df %>%
        filter(gene == g) %>%
        ggplot(aes_string(x = stage, y = "logCPM")) +
        geom_point(alpha = 0.7) +
        geom_smooth(method = "lm", se = FALSE, color = "steelblue") +
        labs(
          title = paste("Gene:", g),
          subtitle = paste("Life stage:", stage),
          x = stage,
          y = "logCPM"
        )
    }
  ))

# Print the plots
walk2(
  plot_list$plot,
  paste0("log_vs_cpm/logCPM_vs_", plot_list$life_stage, "_", plot_list$gene, ".png"),
  ~ ggsave(filename = .y, plot = .x, width = 6, height = 4, units = "in")
)


# Add biology annotation to all hits
desc_raw <- read_tsv("significant_genes_description.txt", 
                     col_names = FALSE, comment = "#", quote = "") 

desc_df <- desc_raw %>%
  mutate(
    gene_id = str_extract(X9, 'gene_id \\"[^"]+\\"') %>% str_remove_all('gene_id \\"|\\"'),
    description = str_extract(X9, 'description \\"[^"]+\\"') %>% str_remove_all('description \\"|\\"')
  ) %>%
  select(gene_id, description) %>%
  distinct(gene_id, .keep_all = TRUE) %>%
  mutate(gene_id = str_remove(gene_id, "_i.*")) %>%
  unique()

top_hits_strict_annotated <- top_hits_strict %>%
  left_join(desc_df, by = c("gene" = "gene_id"))

write_tsv(top_hits_strict_annotated, "spearmen_idc_cpm_from_sig_de.txt")
```

Important directories (final hits/biology):
/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv_iso/nonzero_counts_30_multiple_iso
/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv_iso/nonzero_counts_30


# Add information on isoform completeness to significant isoforms

```{R,eval=F}
library(tidyverse)

sig_genes <- read_tsv("nonzero_counts_30_multiple_iso/significant_genes_description_combined.tsv") 

length <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/trinity_assembly_unique_non_cod.Trinotate.with_full_length.tsv") %>%
  select(1, 2, "full_length")  %>%
  filter(`#gene_id` %in% sig_genes$gene) 

genes_with_full_length <- length %>%
  rename(gene = transcript_id) 

sig_genes %>%
  left_join(
    genes_with_full_length
  ) %>%
  write_tsv("nonzero_counts_30_multiple_iso/significant_genes_description_combined_isoform_length.tsv")

read_tsv("nonzero_counts_30_multiple_iso/significant_genes_description_combined_brief.tsv") %>%
  left_join(
    genes_with_full_length
  ) %>%
  write_tsv("nonzero_counts_30_multiple_iso/significant_genes_description_combined_brief_isoform_length.tsv")
```


# Additional analyses & plots

# Clustering for significant genes

```{R,eval=F}
# Load necessary libraries
library(consensusDE)
library(tidyverse)
library(readxl)
library(SummarizedExperiment)
library(magrittr)
library(edgeR)
library(RUVSeq)
library(Biobase)
library(DESeq2)
library(pheatmap)
library(limma)
library(patchwork)
library(matrixStats)  

# Read in and set up data
summarised_de_filter <- readRDS("summarized_de_filter.rds")

# voom-limma

# Setup
counts <- round(assay(summarised_de_filter))
meta <- colData(summarised_de_filter)

# Extract RUV factors (e.g., W_1, W_2 if k = 2)
W_vars <- grep("^W_", colnames(meta), value = TRUE)

# Ensure 'group' is a factor
meta$group <- factor(meta$group)

# Design matrix including RUV factors and group
design_formula <- as.formula(paste("~ batch +", paste(c(W_vars, "group"), collapse = " + ")))
design <- model.matrix(design_formula, data = meta)

# Create DGEList object
dge <- DGEList(counts = counts)
dge <- calcNormFactors(dge)

# Apply voom transformation
v <- voom(dge, design, plot = TRUE)

# PCAs based on filtered/significant genes

# Load filtered gene set (assuming already loaded into overlap_all_sample_counts)
# Also assuming 'gene' column contains transcript IDs matching voom_res_df

## Step 1: Filter to genes with count > 10 and prop_nonzero >= 0.3 in both groups
filtered_gene_set <- read_tsv("significant_overlap_with_nonzero_counts.tsv") %>%
    mutate(parent = str_remove(gene, "_i.*")) %>%
    filter(prop_nonzero_Um >= 0.3, prop_nonzero_Sm >= 0.3) %>%
    pull(gene) %>%
    unique()

## Step 2: Intersect with significant voom genes
voom_res_df <- read_tsv("voom_results_full.tsv") 

sig_genes_voom <- voom_res_df %>%
    filter(!is.na(adj.P.Val), adj.P.Val < 0.05, abs(logFC) > 1) %>%
    pull(gene)

filtered_sig_genes <- intersect(filtered_gene_set, sig_genes_voom)

## Step 3: Subset voom expression matrix
voom_filtered_sig <- v$E[filtered_sig_genes, ]

## Step 4: Apply batch correction
voom_filtered_sig_corrected <- removeBatchEffect(voom_filtered_sig,
    batch = meta$batch,
    covariates = meta$W_1
)

## Step 5: PCA
pca_results_filtered_sig <- prcomp(t(voom_filtered_sig_corrected))
var_expl <- summary(pca_results_filtered_sig)$importance[2, ]

## Step 6: Prepare PCA scores for plotting
pca_scores_filtered_sig <- data.frame(pca_results_filtered_sig$x) %>%
    rownames_to_column("sample") %>%
    left_join(as.data.frame(meta), by = c("sample" = "file"))  # adjust if needed

attr(pca_scores_filtered_sig, "var_expl") <- var_expl

# Add IDC classification
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
    mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores_filtered_sig <- pca_scores_filtered_sig %>% 
    select(-c(celltype, schizont, ring, trophozoite)) %>%
    left_join(
        idc_df
    ) %>%
    mutate(gametocyte_total = gametocyte_developing + gametocyte_female + gametocyte_male) %>%
    mutate(sexual = gametocyte_female + gametocyte_male + gametocyte_developing,
        asexual = schizont + ring + trophozoite)

## Step 7: Plot
## PC1 vs PC2 plot using same aesthetics as plot_pca_pairs

## Labels
x_lab <- paste0("PC1: ", round(var_expl[1] * 100, 2), "% variance")
y_lab <- paste0("PC2: ", round(var_expl[2] * 100, 2), "% variance")

## Base plot
export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC2)) +
    geom_point(aes(colour = group)) +
    xlab(x_lab) +
    ylab(y_lab) +
    stat_ellipse(aes(colour = group), type = "norm", linetype = "dashed", linewidth = 1) +
    scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

## Save to file
ggsave("pca_voom_filtered_sig_batch_corrected_group_PC1_PC2.png", plot = export_plot, dpi = 300)

## PC1 vs PC3
x_lab <- paste0("PC1: ", round(var_expl[1] * 100, 2), "% variance")
y_lab <- paste0("PC3: ", round(var_expl[3] * 100, 2), "% variance")

export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC3)) +
    geom_point(aes(colour = group)) +
    xlab(x_lab) +
    ylab(y_lab) +
    stat_ellipse(aes(colour = group), type = "norm", linetype = "dashed", linewidth = 1) +
    scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_filtered_sig_batch_corrected_group_PC1_PC3.png", plot = export_plot, dpi = 300)



## PCA with gametocyte_total (and other IDC features)

## Base plot
export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC2)) +
    geom_point(aes(colour = gametocyte_total)) +
    xlab(x_lab) +
    ylab(y_lab) +
    scale_color_viridis_c(option = "D", name = "Gametocyte total")

## Save to file
ggsave("pca_voom_filtered_sig_batch_corrected_gametocyte_total_PC1_PC2.png", plot = export_plot, dpi = 300)

## Test association between PC1 and gametocyte_total
## Fit linear model
lm_model <- lm(PC1 ~ gametocyte_total, data = pca_scores_filtered_sig)

## Summary statistics
summary(lm_model)

## Extract R-squared and p-value
r_squared <- summary(lm_model)$r.squared
p_value <- summary(lm_model)$coefficients["gametocyte_total", "Pr(>|t|)"]

## Print results
cat("R-squared:", round(r_squared, 3), "\n")
cat("p-value:", signif(p_value, 3), "\n")



# PCA - Identify top 50 most variable genes after correction
top_variable_genes_voom <- order(rowVars(voom_filtered_sig_corrected), decreasing = TRUE)[1:50]
voom_top_var_corrected <- voom_filtered_sig_corrected[top_variable_genes_voom, ]

## PCA
pca_results_filtered_sig <- prcomp(t(voom_top_var_corrected))
var_expl <- summary(pca_results_filtered_sig)$importance[2, ]

## Prepare PCA scores for plotting
pca_scores_filtered_sig <- data.frame(pca_results_filtered_sig$x) %>%
    rownames_to_column("sample") %>%
    left_join(as.data.frame(meta), by = c("sample" = "file"))  # adjust if needed

attr(pca_scores_filtered_sig, "var_expl") <- var_expl

# Add IDC classification
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
    mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores_filtered_sig <- pca_scores_filtered_sig %>% 
    select(-c(celltype, schizont, ring, trophozoite)) %>%
    left_join(
        idc_df
    ) %>%
    mutate(gametocyte_total = gametocyte_developing + gametocyte_female + gametocyte_male) %>%
    mutate(sexual = gametocyte_female + gametocyte_male + gametocyte_developing,
        asexual = schizont + ring + trophozoite)

## PC1 vs PC2 plot using same aesthetics as plot_pca_pairs

## Labels
x_lab <- paste0("PC1: ", round(var_expl[1] * 100, 2), "% variance")
y_lab <- paste0("PC2: ", round(var_expl[2] * 100, 2), "% variance")

## Base plot
export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC2)) +
    geom_point(aes(colour = group)) +
    xlab(x_lab) +
    ylab(y_lab) +
    stat_ellipse(aes(colour = group), type = "norm", linetype = "dashed", linewidth = 1) +
    scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

## Save to file
ggsave("pca_voom_filtered_sig_top50_batch_corrected_group_PC1_PC2.png", plot = export_plot, dpi = 300)

## Base plot
export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC3)) +
    geom_point(aes(colour = group)) +
    xlab(x_lab) +
    ylab(y_lab) +
    stat_ellipse(aes(colour = group), type = "norm", linetype = "dashed", linewidth = 1) +
    scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

## Save to file
ggsave("pca_voom_filtered_sig_top50_batch_corrected_group_PC1_PC3.png", plot = export_plot, dpi = 300)


## PCA with gametocyte_total (and other IDC features)

## Base plot
export_plot <- ggplot(pca_scores_filtered_sig, aes(x = PC1, y = PC2)) +
    geom_point(aes(colour = gametocyte_total)) +
    xlab(x_lab) +
    ylab(y_lab) +
    scale_color_viridis_c(option = "D", name = "Gametocyte total")

## Save to file
ggsave("pca_voom_filtered_sig_top50_batch_corrected_gametocyte_total_PC1_PC2.png", plot = export_plot, dpi = 300)


## Test association between PC1 and gametocyte_total
## Fit linear model
lm_model <- lm(PC1 ~ gametocyte_total, data = pca_scores_filtered_sig)
cor.test(pca_scores_filtered_sig$PC1, pca_scores_filtered_sig$gametocyte_total, method = "spearman")

## Summary statistics
summary(lm_model)

## Extract R-squared and p-value
r_squared <- summary(lm_model)$r.squared
p_value <- summary(lm_model)$coefficients["gametocyte_total", "Pr(>|t|)"]

## Print results
cat("R-squared:", round(r_squared, 3), "\n")
cat("p-value:", signif(p_value, 3), "\n")






# Batch-corrected PCA for IDC proportions on top 1,000 most variable genes (voom) - not just significant genes

# Apply removeBatchEffect to voom logCPM
voom_corrected <- removeBatchEffect(v$E, batch = meta$batch, covariates = meta$W_1)

# Identify top 1,000 most variable genes after correction
top_variable_genes_voom <- order(rowVars(voom_corrected), decreasing = TRUE)[1:1000]
voom_top_var_corrected <- voom_corrected[top_variable_genes_voom, ]

# Perform PCA
pca_results_voom <- prcomp(t(voom_top_var_corrected))
var_expl_voom <- summary(pca_results_voom)$importance[2, ]

# Prepare PCA scores
meta_df <- as.data.frame(meta) %>%
  rownames_to_column("sample")

pca_scores_voom <- data.frame(pca_results_voom$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")

# Add IDC classification
# Add IDC classification
idc_df <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/idc_mapping/pf_ref/scaden_mean_proportions.txt") %>% 
    mutate(sample_id = str_replace(sample_id, "-", "_")) 

pca_scores_voom <- pca_scores_voom %>% 
    select(-c(celltype, schizont, ring, trophozoite)) %>%
    left_join(
        idc_df
    ) %>%
    mutate(gametocyte_total = gametocyte_developing + gametocyte_female + gametocyte_male) %>%
    mutate(sexual = gametocyte_female + gametocyte_male + gametocyte_developing,
        asexual = schizont + ring + trophozoite)


#Plot
## PC1 vs PC2 plot using same aesthetics as plot_pca_pairs

## Labels
x_lab <- paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance")
y_lab <- paste0("PC2: ", round(var_expl_voom[2] * 100, 2), "% variance")

## Base plot
export_plot <- ggplot(pca_scores_voom, aes(x = PC1, y = PC2)) +
    geom_point(aes(colour = gametocyte_total)) +
    xlab(x_lab) +
    ylab(y_lab) +
    scale_color_viridis_c(option = "D", name = "Gametocyte total")

## Save to file
ggsave("pca_voom_1000_batch_corrected_gametocyte_gametocyte_total_PC1_PC2.png", plot = export_plot, dpi = 300)

## Test association between PC1 and gametocyte_total
## Fit linear model
lm_model <- lm(PC1 ~ gametocyte_total, data = pca_scores_voom)
cor.test(pca_scores_voom$PC1, pca_scores_voom$gametocyte_total, method = "spearman")

## Summary statistics
summary(lm_model)

## Extract R-squared and p-value
r_squared <- summary(lm_model)$r.squared
p_value <- summary(lm_model)$coefficients["gametocyte_total", "Pr(>|t|)"]

## Print results
cat("R-squared:", round(r_squared, 3), "\n")
cat("p-value:", signif(p_value, 3), "\n")



# Run all again and combine into output
# Function to run lm() and extract stats
test_pc_association <- function(pc_scores, pc, variable) {
    formula <- as.formula(paste(pc, "~", variable))
    model <- lm(formula, data = pc_scores)
    r2 <- summary(model)$r.squared
    pval <- summary(model)$coefficients[variable, "Pr(>|t|)"]
    
    tibble(
      PC = pc,
      Variable = variable,
      R_squared = round(r2, 3),
      P_value = signif(pval, 3)
    )
  }

# Define your variables of interest
pc_vars <- c("PC1", "PC2", "PC3")
gametocyte_vars <- c("gametocyte_total", "gametocyte_female", "gametocyte_male",
                     "gametocyte_developing", "sexual", "asexual", "schizont", "trophozoite", "ring")

# Run all combinations
gametocyte_assoc_summary <- purrr::map_dfr(
    .x = pc_vars,
    .f = function(pc) {
      purrr::map_dfr(
        .x = gametocyte_vars,
        .f = function(var) {
          test_pc_association(pca_scores_voom, pc, var)
        }
      )
    }
  ) %>%
  arrange(PC, P_value)

write_tsv(gametocyte_assoc_summary, "pca_voom_1000_batch_corrected_gametocyte_assoc_summary.tsv")



# Boxplot of PCs by group

## Apply removeBatchEffect to voom logCPM
voom_corrected <- removeBatchEffect(v$E, batch = meta$batch, covariates = meta$W_1)

## Identify top 1,000 most variable genes after correction
top_variable_genes_voom <- order(rowVars(voom_corrected), decreasing = TRUE)[1:1000]
voom_top_var_corrected <- voom_corrected[top_variable_genes_voom, ]

## Perform PCA
pca_results_voom <- prcomp(t(voom_top_var_corrected))
var_expl_voom <- summary(pca_results_voom)$importance[2, ]

## Prepare PCA scores
meta_df <- as.data.frame(meta) %>%
  rownames_to_column("sample")

pca_scores_voom <- data.frame(pca_results_voom$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")

boxplot_pc1 <- ggplot(pca_scores_voom, aes(x = group, y = PC1, fill = group)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.2, alpha = 0.5) +
    scale_fill_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
    labs(x = "Group", y = "PC1") +
    theme(
      legend.position = "none",
    )

ggsave("boxplot_pc1_by_group.png", plot = boxplot_pc1, dpi = 300, width = 6, height = 4)


boxplot_pc2 <- ggplot(pca_scores_voom, aes(x = group, y = PC2, fill = group)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.2, alpha = 0.5) +
    scale_fill_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
    labs(x = "Group", y = "PC2") +
    theme(
      legend.position = "none",
    )

ggsave("boxplot_pc2_by_group.png", plot = boxplot_pc2, dpi = 300, width = 6, height = 4)

# Pivot to long format
pca_long <- pca_scores_voom %>%
  select(sample = file, group, PC1, PC2, PC3, batch) %>%
  pivot_longer(cols = starts_with("PC"), names_to = "PC", values_to = "score")

# Plot
boxplot_pcs <- ggplot(pca_long, aes(x = group, y = score, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~ PC, scales = "free_y") +
  scale_fill_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
  labs(x = "Group", y = "PC Score") +
  theme(
    legend.position = "none"
  )

# Save
ggsave("boxplot_PC1_PC2_by_group.png", plot = boxplot_pcs, dpi = 300, width = 8, height = 4)


# meta
pca_long <- pca_long %>% 
  left_join(
    meta %>%
      as.data.frame() %>%
      select(sample = file, sex, age, cluster)
  )

# Plot
boxplot_pcs <- ggplot(pca_long, aes(x = group, y = score, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, aes(colour = sex)) +
  facet_wrap(~ PC, scales = "free_y") +
  scale_fill_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
  scale_color_manual(values = c("M" = "#f98e09", "F" = "#bc3754")) +
  labs(x = "Group", y = "PC Score")

# Save
ggsave("boxplot_PC1_PC2_by_sex.png", plot = boxplot_pcs, dpi = 300, width = 8, height = 4)


# Plot
boxplot_pcs <- ggplot(pca_long, aes(x = group, y = score, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, aes(colour = age)) +
  facet_wrap(~ PC, scales = "free_y") +
  scale_fill_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
  scale_color_viridis_c(option = "inferno") +
  labs(x = "Group", y = "PC Score") 

# Save
ggsave("boxplot_PC1_PC2_by_age.png", plot = boxplot_pcs, dpi = 300, width = 8, height = 4)


# Test association between PCs and age and sex

pca_wide <- pca_long %>%
  select(sample, group, batch, PC, score, sex, age, cluster) %>%
  pivot_wider(names_from = PC, values_from = score)

# Linear model: PC3 ~ age
lm_age <- lm(PC3 ~ age, data = pca_wide)

# Correlation test (Spearman, since age might not be normal)
cor.test(pca_wide$PC3, pca_wide$age, method = "spearman")

# Summary
summary(lm_age)

# Extract stats
r_squared_age <- summary(lm_age)$r.squared
p_value_age <- summary(lm_age)$coefficients["age", "Pr(>|t|)"]

# Print results
cat("PC3 ~ Age\n")
cat("R-squared:", round(r_squared_age, 3), "\n")
cat("p-value:", signif(p_value_age, 3), "\n\n")

# Linear model: PC3 ~ sex
lm_sex <- lm(PC3 ~ sex, data = pca_wide)

# Summary
summary(lm_sex)

# Extract stats
# Note: one level of sex becomes baseline (alphabetical by default, likely "F")
r_squared_sex <- summary(lm_sex)$r.squared
p_value_sex <- summary(lm_sex)$coefficients["sexM", "Pr(>|t|)"]

# Print results
cat("PC3 ~ Sex\n")
cat("R-squared:", round(r_squared_sex, 3), "\n")
cat("p-value (M vs F):", signif(p_value_sex, 3), "\n")

# Combine stats
pc3_assoc_summary <- tibble::tibble(
  Predictor = c("Age", "Sex"),
  R_squared = c(r_squared_age, r_squared_sex),
  P_value = c(p_value_age, p_value_sex)
)

# Save to file
write_tsv(pc3_assoc_summary, "pc3_associations_with_age_sex.txt")



# Heatmaps
## Step 1: Z-score normalization
voom_z <- t(scale(t(voom_filtered_sig_corrected)))

## Step 2: Hierarchical clustering
# Cluster genes (rows)
gene_order <- hclust(dist(voom_z))$order
ordered_genes <- rownames(voom_z)[gene_order]

## Cluster samples (columns)
sample_order <- hclust(dist(t(voom_z)))$order
ordered_samples <- colnames(voom_z)[sample_order]

## Step 3: Reshape to long format
plot_df <- voom_z %>%
    as.data.frame() %>%
    rownames_to_column("gene") %>%
    pivot_longer(-gene, names_to = "sample", values_to = "zscore") %>%
    left_join(as.data.frame(meta), by = c("sample" = "file")) %>%
    mutate(
        gene = factor(gene, levels = ordered_genes),
        sample = factor(sample, levels = ordered_samples)
    )

## Step 4: Plot heatmap
p <- ggplot(plot_df, aes(x = sample, y = gene, fill = zscore)) +
    geom_tile(color = "grey90") +
    scale_fill_viridis_c(option = "D", name = "Z-score") +
    facet_grid(~group, scales = "free_x", space = "free_x",
                         labeller = as_labeller(c(Um = "Uncomplicated", Sm = "Severe"))) +
    theme(
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        strip.text = element_text(size = 12),
        axis.title = element_text(size = 14)
    ) +
    ylab("Significant Genes") +
    xlab("Samples")

## Step 5: Save plot
ggsave("heatmap_voom_filtered_sig_ggplot.png", plot = p, dpi = 300, width = 12, height = 6)




# Get top 50 DE genes by adjusted p-value

# Step 1: Z-score normalization across genes (rows)
voom_top_var_z <- t(scale(t(voom_top_var_corrected)))

# Step 2: Cluster rows (genes) and columns (samples)
gene_order <- hclust(dist(voom_top_var_z))$order
sample_order <- hclust(dist(t(voom_top_var_z)))$order
ordered_genes <- rownames(voom_top_var_z)[gene_order]
ordered_samples <- colnames(voom_top_var_z)[sample_order]

# Step 3: Long format for ggplot
plot_df <- voom_top_var_z %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "zscore") %>%
  left_join(as.data.frame(meta), by = c("sample" = "file")) %>%
  mutate(
    gene = factor(gene, levels = ordered_genes),
    sample = factor(sample, levels = ordered_samples)
  )

# Step 4: Plot heatmap using ggplot
heatmap_plot <- ggplot(plot_df, aes(x = sample, y = gene, fill = zscore)) +
  geom_tile(color = "grey90") +
  scale_fill_viridis_c(option = "D", name = "Z-score") +
  facet_grid(~group, scales = "free_x", space = "free_x",
             labeller = as_labeller(c(Um = "Uncomplicated", Sm = "Severe"))) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(size = 12),
    axis.title = element_text(size = 14)
  ) +
  labs(x = "Samples", y = "Top 50 Most Variable Genes")

# Step 5: Save to file
ggsave("heatmap_voom_top50_variable_batch_corrected.png", plot = heatmap_plot, dpi = 300, width = 12, height = 6)

library(ComplexHeatmap)
library(circlize)

# Ensure the matrix is numeric and ordered (optional)
voom_top_var_z <- t(scale(t(voom_top_var_corrected)))

# Define annotation for samples
ha_col <- HeatmapAnnotation(
  Group = meta$group[match(colnames(voom_top_var_z), meta$file)],
  col = list(Group = c("Um" = "#440154FF", "Sm" = "#55C667FF"))
)

# Plot heatmap with clustering
png("heatmap_voom_top50_variable_batch_corrected_dendrogram.png", width = 2000, height = 1200, res = 300)
Heatmap(voom_top_var_z,
        name = "Z-score",
        top_annotation = ha_col,
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        show_row_names = FALSE,
        show_column_names = FALSE,
        column_split = meta$group[match(colnames(voom_top_var_z), meta$file)],
        col = colorRamp2(c(-2, 0, 2), c("#22a884", "white", "#414487")),
        heatmap_legend_param = list(title = "Z-score")
)
dev.off()
```

# Explore contribution of technical factors to variance

```{R,eval=F}
library(edgeR)
library(tidyverse)
library(ggpmisc)
library(SummarizedExperiment)

# Read in and set up data
summarised_de_filter <- readRDS("summarized_de_filter.rds")

# voom-limma

# Setup
counts <- round(assay(summarised_de_filter))
meta <- colData(summarised_de_filter)

# Extract RUV factors (e.g., W_1, W_2 if k = 2)
W_vars <- grep("^W_", colnames(meta), value = TRUE)

# Ensure 'group' is a factor
meta$group <- factor(meta$group)

# Design matrix including RUV factors and group
design_formula <- as.formula(paste("~ batch +", paste(c(W_vars, "group"), collapse = " + ")))
design <- model.matrix(design_formula, data = meta)

# Create DGEList object
dge <- DGEList(counts = counts)
dge <- calcNormFactors(dge)

# Apply voom transformation
v <- voom(dge, design, plot = TRUE)

# Apply removeBatchEffect to voom logCPM
voom_corrected <- removeBatchEffect(v$E, batch = meta$batch, covariates = meta$W_1)

# Identify top 1,000 most variable genes after correction
top_variable_genes_voom <- order(rowVars(voom_corrected), decreasing = TRUE)[1:1000]
voom_top_var_corrected <- voom_corrected[top_variable_genes_voom, ]

# Perform PCA
pca_results_voom <- prcomp(t(voom_top_var_corrected))
var_expl_voom <- summary(pca_results_voom)$importance[2, ]

# Prepare PCA scores
meta_df <- as.data.frame(meta) %>%
  rownames_to_column("sample")

pca_scores_voom <- data.frame(pca_results_voom$x) %>%
  rownames_to_column("sample") %>%
  left_join(meta_df, by = "sample")

# Calculate CPM
cpm_mat <- cpm(counts)

# Get transcripts detected (CPM > 1) per sample
transcripts_detected <- colSums(cpm_mat > 1)

# Total raw library size per sample
library_size <- colSums(counts)

# Reads mapping to Pk

# Step 1: Define path and read all STAR log files
log_files <- list.files(path = "/g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_assembly/output/mapped", pattern = "Log.final.out$", full.names = TRUE)

# Step 2: Extract uniquely mapped reads from each file
mapped_reads_df <- map_dfr(log_files, function(file) {
  lines <- readLines(file)
  unique_line <- lines[grepl("Uniquely mapped reads number", lines)]
  mapped_reads <- as.numeric(str_trim(str_split_fixed(unique_line, "\\|", 2)[,2]))

  sample_name <- basename(file) %>%
    str_replace(".Log.final.out", ".txt")

  tibble(sample = sample_name, mapped_reads = mapped_reads)
})

# Create a data.frame of technical factors
tech_factors <- data.frame(
    sample = colnames(counts),
    transcripts_detected = transcripts_detected,
    library_size = library_size
  ) %>%
  left_join(
    mapped_reads_df %>%
      mutate(sample = str_replace(sample, "-", "_")) 
  )

pca_scores_voom <- pca_scores_voom %>%
  left_join(tech_factors, by = "sample")

# Calculate variance explained by each PC
plot_library_size <- ggplot(pca_scores_voom, aes(x = library_size, y = PC1)) +
  geom_point(aes(colour = group)) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.., sep = "~~~")),
    formula = y ~ x, parse = TRUE, label.x = "right", label.y = "top"
  ) +
  labs(
    x = "Total Library Size (raw counts)",
    y = "PC1 Score",
    colour = "Group"
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_PC1_vs_library_size.png", plot = plot_library_size, dpi = 300)

plot_transcripts_detected <- ggplot(pca_scores_voom, aes(x = transcripts_detected, y = PC1)) +
  geom_point(aes(colour = group)) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.., sep = "~~~")),
    formula = y ~ x, parse = TRUE, label.x = "right", label.y = "top"
  ) +
  labs(
    x = "Number of Transcripts Detected",
    y = "PC1 Score",
    colour = "Group"
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_PC1_vs_transcripts_detected.png", plot = plot_transcripts_detected, dpi = 300)

plot_mapped_reads <- ggplot(pca_scores_voom, aes(x = mapped_reads, y = PC1)) +
  geom_point(aes(colour = group)) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.., sep = "~~~")),
    formula = y ~ x, parse = TRUE, label.x = "right", label.y = "top"
  ) +
  labs(
    x = "Number of Mapped Reads",
    y = "PC1 Score",
    colour = "Group"
  ) +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF"))

ggsave("pca_voom_PC1_vs_mapped_reads.png", plot = plot_mapped_reads, dpi = 300)

# Plot PCA scores colored by technical factors
pca_libsize_plot <- ggplot(pca_scores_voom, aes(x = PC1, y = PC2, colour = library_size)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Library Size",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(var_expl_voom[2] * 100, 2), "% variance"),
    colour = "Library Size"
  ) +
  scale_color_viridis_c(option = "D", name = "Library Size")

ggsave("pca_voom_PC1_PC2_coloured_by_library_size.png", plot = pca_libsize_plot, dpi = 300)

pca_tx_detected_plot <- ggplot(pca_scores_voom, aes(x = PC1, y = PC2, colour = transcripts_detected)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Transcripts Detected",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(var_expl_voom[2] * 100, 2), "% variance"),
    colour = "Transcripts Detected"
  ) +
  scale_color_viridis_c(option = "D", name = "Transcripts Detected")

ggsave("pca_voom_PC1_PC2_coloured_by_transcripts_detected.png", plot = pca_tx_detected_plot, dpi = 300)

pca_mapped_reads_plot <- ggplot(pca_scores_voom, aes(x = PC1, y = PC2, colour = mapped_reads)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Mapped Reads",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC2: ", round(var_expl_voom[2] * 100, 2), "% variance"),
    colour = "Mapped Reads"
  ) +
  scale_color_viridis_c(option = "D", name = "Mapped Reads")

ggsave("pca_voom_PC1_PC2_coloured_by_mapped_reads.png", plot = pca_mapped_reads_plot, dpi = 300)

# PC1 vs PC3 plots
pca_libsize_plot_pc13 <- ggplot(pca_scores_voom, aes(x = PC1, y = PC3, colour = library_size)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Library Size (PC1 vs PC3)",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC3: ", round(var_expl_voom[3] * 100, 2), "% variance"),
    colour = "Library Size"
  ) +
  scale_color_viridis_c(option = "D", name = "Library Size")

ggsave("pca_voom_PC1_PC3_coloured_by_library_size.png", plot = pca_libsize_plot_pc13, dpi = 300)

pca_tx_detected_plot_pc13 <- ggplot(pca_scores_voom, aes(x = PC1, y = PC3, colour = transcripts_detected)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Transcripts Detected (PC1 vs PC3)",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC3: ", round(var_expl_voom[3] * 100, 2), "% variance"),
    colour = "Transcripts Detected"
  ) +
  scale_color_viridis_c(option = "D", name = "Transcripts Detected")

ggsave("pca_voom_PC1_PC3_coloured_by_transcripts_detected.png", plot = pca_tx_detected_plot_pc13, dpi = 300)

pca_mapped_reads_plot_pc13 <- ggplot(pca_scores_voom, aes(x = PC1, y = PC3, colour = mapped_reads)) +
  geom_point(size = 2) +
  labs(
    title = "PCA: Colored by Mapped Reads (PC1 vs PC3)",
    x = paste0("PC1: ", round(var_expl_voom[1] * 100, 2), "% variance"),
    y = paste0("PC3: ", round(var_expl_voom[3] * 100, 2), "% variance"),
    colour = "Mapped Reads"
  ) +
  scale_color_viridis_c(option = "D", name = "Mapped Reads")

ggsave("pca_voom_PC1_PC3_coloured_by_mapped_reads.png", plot = pca_mapped_reads_plot_pc13, dpi = 300)

## Test association between PC1 and factors
## Fit linear model
# Set up
vars_to_test <- c("library_size", "transcripts_detected", "mapped_reads")
pcs_to_test <- paste0("PC", 1:10)

# Loop and store results
results <- expand.grid(PC = pcs_to_test, variable = vars_to_test, stringsAsFactors = FALSE) %>%
  mutate(
    r_squared = NA_real_,
    lm_p_value = NA_real_,
    spearman_rho = NA_real_,
    spearman_p_value = NA_real_
  )

for (i in seq_len(nrow(results))) {
  pc <- results$PC[i]
  var <- results$variable[i]

  lm_formula <- as.formula(paste(pc, "~", var))
  lm_model <- lm(lm_formula, data = pca_scores_voom)

  results$r_squared[i] <- summary(lm_model)$r.squared
  results$lm_p_value[i] <- summary(lm_model)$coefficients[2, "Pr(>|t|)"]

  cor_result <- cor.test(pca_scores_voom[[pc]], pca_scores_voom[[var]], method = "spearman")
  results$spearman_rho[i] <- cor_result$estimate
  results$spearman_p_value[i] <- cor_result$p.value
}

# Print or view results
print(results)

# Optional: write to file
readr::write_tsv(results, "PC_association_stats_tech_factors.tsv")
```

# Supervised clustering

```{R,eval=F}
# Load libraries
library(tidyverse)
library(mixOmics)
library(SummarizedExperiment)

# Step 0: Load data
summarised_de_filter <- readRDS("summarized_de_filter.rds")

# Extract expression matrix and metadata
X <- assay(summarised_de_filter) %>% 
  round() %>% 
  t()  # samples as rows

meta <- as.data.frame(colData(summarised_de_filter))
Y <- meta$group  # outcome variable (e.g., Um vs Sm)
Y <- droplevels(Y)  # in case unused levels exist

# Optional: check and filter for minimal expression or zero variance
X <- X[, apply(X, 2, var) != 0]

# Step 1: Tune model parameters (ncomp and keepX)
set.seed(123)  # for reproducibility

# Define range of variables to test
test_keepX <- c(5, 10, 25, 50, 100)

# Tune number of components and number of features to keep
tune <- tune.splsda(
  X = X,
  Y = Y,
  ncomp = 3,
  validation = "Mfold",
  folds = 5,
  dist = "max.dist",
  progressBar = TRUE,
  measure = "BER",
  test.keepX = test_keepX,
  nrepeat = 10
)

# Optimal parameters
ncomp_opt <- tune$choice.ncomp$ncomp
keepX_opt <- tune$choice.keepX[1:ncomp_opt]

# Step 2: Fit final sPLS-DA model
splsda_model <- splsda(X, Y, ncomp = ncomp_opt, keepX = keepX_opt)

# Step 3: Model performance
perf_splsda <- perf(
  splsda_model,
  validation = "Mfold",
  folds = 5,
  nrepeat = 10,
  progressBar = TRUE,
  feature = TRUE
)

# Step 4: Confusion matrix
predictions <- predict(splsda_model, X)
confusion_matrix <- table(True = Y, Predicted = predictions$class$max.dist[, ncomp_opt])
print(confusion_matrix)

# Step 5: Plot sample separation (PC1 vs PC2)
plot_df <- data.frame(splsda_model$variates$X[, 1:2]) %>%
  rownames_to_column("sample") %>%
  mutate(group = Y)

export_plot <- ggplot(plot_df, aes(x = comp1, y = comp2, colour = group)) +
  geom_point(size = 2.5) +
  stat_ellipse(aes(group = group), linetype = "dashed") +
  scale_color_manual(values = c("Um" = "#440154FF", "Sm" = "#55C667FF")) +
  labs(x = "Component 1", y = "Component 2") 

ggsave("splsda_projection.png", plot = export_plot, dpi = 300, width = 8, height = 6)

# Step 6: Gene loadings (top drivers)
loadings_df <- splsda_model$loadings$X[, 1, drop = FALSE] %>%  # Loadings for component 1
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  dplyr::rename(loading = comp1) %>%
  arrange(desc(abs(loading)))

# Step 7: Heatmap of selected genes
selected_genes <- selectVar(splsda_model, comp = 1)$name
heatmap_data <- t(X[, selected_genes])  # genes x samples
heatmap_data <- scale(heatmap_data)  # z-score

png("heatmap_filtered_sig_complex.png", width = 1200, height = 1000, res = 150)
ComplexHeatmap::draw(
  ComplexHeatmap::Heatmap(
    heatmap_data,
    name = "Z-score",
    column_split = Y,
    show_column_names = FALSE,
    cluster_columns = TRUE,
    cluster_rows = TRUE,
    row_names_gp = grid::gpar(fontsize = 8)
  )
)
dev.off()


# Gene loadings for component 1 - comparison with DE and GSEA
loading_df <- as.data.frame(splsda_model$loadings$X[, 1]) %>%
  rownames_to_column("gene") %>%
  dplyr::rename(loading = 2) %>%
  arrange(desc(abs(loading))) %>%
  head(50)

# Step 1: Read voom DE results
voom_res_df <- read_tsv("voom_results_full.tsv") %>%
  dplyr::rename(voom_logFC = logFC, voom_adj_p = adj.P.Val)

# Step 2: Extract loadings from sPLS-DA Component 1
top_splsda_genes <- selectVar(splsda_model, comp = 1)$value

# Step 3: Tidy into a dataframe
top_splsda_df <- as.data.frame(top_splsda_genes) %>%
  rownames_to_column("gene") %>%
  dplyr::rename(loading = value.var)

# Step 4: Join with voom DE results
top_splsda_with_voom <- top_splsda_df %>%
  left_join(voom_res_df, by = "gene")

# Step 5: View top 20 Component 1 drivers and their DE stats
top_splsda_with_voom %>%
  slice_max(abs(loading), n = 20)


# Top drivers for annotation
loadings <- selectVar(splsda_model, comp = 1)$value

top_genes_df <- loadings %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  dplyr::rename(loading = value.var) %>%
  arrange(desc(abs(loading))) %>%
  dplyr::slice(1:20) %>%
  mutate(direction = if_else(loading > 0, "Sm", "Um"))

write_tsv(top_genes_df, "top_genes_df_splsda.tsv")
```



## Combine annotation and significant genes

```{bash,eval=F}
cp top_genes_df_splsda.tsv splsda_anno/
cd splsda_anno/
awk '{print $1}' top_genes_df_splsda.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/smk_trinity_unique_trans/output/genome_annotation/Trinity_annot_with_full_annotations.gtf > significant_genes_annotation.txt
grep 'description' significant_genes_annotation.txt > significant_genes_description.txt
```

```{R,eval=F}
library(tidyverse)

# Read in the DE results
de_results <- read_tsv("top_genes_df_splsda.tsv")

# Read in the description file
desc_raw <- read_tsv("significant_genes_description.txt", col_names = FALSE)

# Extract gene_id and description from the 9th column (attributes)
desc_clean <- desc_raw %>%
  select(X9) %>%
  mutate(
    gene = str_extract(X9, 'gene_id\\s+\\"(TRINITY[^"]+)') %>% str_remove('gene_id\\s+\\"'),
    description = str_extract(X9, 'description\\s+\\"([^"]+)') %>% str_remove('description\\s+\\"')
  ) %>%
  select(gene, description) %>%
  mutate(gene = str_remove(gene, "_i.*")) %>%
  distinct()  # remove duplicate entries for the same gene

# Join with DE results
de_with_desc <- de_results %>%
  left_join(desc_clean, by = "gene")  

write_tsv(de_with_desc, "significant_genes_with_description.tsv")
```


# Annotating significant genes using de novo annotation (Trinotate)

## De novo annotation 
Look at /g/data/pq84/malaria/Pk_trancsriptomics/scripts/Trinotate.Rmd to generate annotations (trinity_assembly_unique.Trinotate.tsv)


## Combine annotation and significant genes (from both reference genome method and de novo method)

```{bash,eval=F}
awk '{print $1}' top_genes_df_splsda.tsv | grep -v gene > significant_gene_patterns.txt
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique_non_cod.Trinotate.tsv | 
cat <(head -n 1 /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/trinity_assembly_unique.Trinotate.tsv) - \
> significant_genes_annotation_trinotate.txt
```

### Generate a file with biological descriptions for Infernal 'genes'

```{bash,eval=F}
grep -F -f significant_gene_patterns.txt /g/data/pq84/malaria/Pk_trancsriptomics/outputs/annotation/diamond/infernal_combined.out > infernal_descriptions_sig_genes.txt
```

```{R,eval=F}
library(tidyverse)

trinotate <- read_tsv("significant_genes_annotation_trinotate.txt", na = c(".", "")) %>%
  rename(gene = `#gene_id`) %>%
  arrange(
    gene,
    desc(!is.na(sprot_Top_BLASTX_hit)),
    desc(!is.na(sprot_Top_BLASTP_hit)),
    desc(!is.na(Pfam)),
    desc(!is.na(SignalP)),
    desc(!is.na(TmHMM)),
    desc(!is.na(Kegg))
  )

# merge data
#merged_anno <- 
trinotate %>%
  group_by(gene) %>%
  summarise(
    transcript_ids = paste(unique(transcript_id), collapse = ","),
    across(
      -transcript_id,
      ~ {
        vals <- unique(na.omit(.x))
        if (length(vals) == 0) NA_character_ else if (length(vals) == 1) vals else paste(vals, collapse = ",")
      }
    ),
    .groups = "drop"
  ) %>%
  relocate(transcript_ids, .after = last_col()) %>%
  mutate(
    sprot_Top_BLASTX_hit = str_remove(sprot_Top_BLASTX_hit, ".*Full="),
    sprot_Top_BLASTX_hit = str_remove(sprot_Top_BLASTX_hit, ";.*"),
    sprot_Top_BLASTP_hit = str_remove(sprot_Top_BLASTP_hit, ".*Full="),
    sprot_Top_BLASTP_hit = str_remove(sprot_Top_BLASTP_hit, ";.*"),
    
    # Extract all Rfam model names from the infernal column
    infernal = ifelse(
      is.na(infernal),
      NA,
      infernal %>%
        str_split("`") %>%
        map_chr(~ paste0(unique(str_extract(.x, "^[^\\^]+")), collapse = ","))
    )
  ) %>%
  mutate(across(where(is.character), ~ na_if(.x, "")))

merged_anno %>%
  write_tsv("significant_genes_description_combined.tsv")

merged_anno %>%
  mutate(
    description = case_when(
      !is.na(PKA1H1_description) ~ PKA1H1_description,
      !is.na(sprot_Top_BLASTX_hit) ~ sprot_Top_BLASTX_hit,
      !is.na(sprot_Top_BLASTP_hit) ~ sprot_Top_BLASTP_hit,
      !is.na(infernal) ~ infernal,
      TRUE ~ NA_character_
    ),
    description_source = case_when(
      !is.na(PKA1H1_description) ~ "PKA1H1",
      !is.na(sprot_Top_BLASTX_hit) ~ "BLASTX",
      !is.na(sprot_Top_BLASTP_hit) ~ "BLASTP",
      !is.na(infernal) ~ "Infernal",
      TRUE ~ NA_character_
    ),
    higher_expression = case_when(
      is.na(logFC_voom) ~ NA_character_,
      logFC_voom < 0 ~ "Um",
      logFC_voom > 0 ~ "Sm",
      TRUE ~ "No change"
    )
  ) %>%
  select(
    gene,
    description,
    description_source,
    padj_voom,
    logFC_voom,
    higher_expression
  ) %>%
  mutate(padj_voom = round(padj_voom, 3)) %>%
  arrange(desc(!is.na(description))) %>%
  write_tsv("significant_genes_description_combined_brief.tsv")
```

# Is severe disease associated with fever?

```{R,eval=F}
library(consensusDE)
library(tidyverse)
library(readxl)
library(SummarizedExperiment)
library(edgeR)  # for cpm()
library(tidyverse)

# Fever and severity
fever_data <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/full_meta_for_de.tsv") %>%
  dplyr::select(studyid, sevemal, file, parasitemia) %>% 
  dplyr::rename(sampleid = file) %>%
  left_join(
    read_xlsx("/g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/human_genomics/axiom_array/outdir/analyses/Sabah_MASTER_patientsummary_22.2.23.xlsx") %>%
      dplyr::select(temp, code) %>%
      dplyr::rename(studyid = code)
  ) %>%
  na.omit()

# Run Wilcoxon test and extract p-value
wilcox_res <- wilcox.test(temp ~ sevemal, data = fever_data)
pval <- signif(wilcox_res$p.value, 3)

# Plot
export_plot <- fever_data %>%
  ggplot(aes(x = sevemal, y = temp)) +
  geom_boxplot() +
  geom_jitter(width = 0.2) +
  labs(x = "Severe malaria", y = "Temperature (Celsius)",
       subtitle = paste0("Wilcoxon p = ", pval)) +
  scale_x_discrete(labels = c("Um" = "Uncomplicated", "Sm" = "Severe"))

ggsave("fever_vs_severe_malaria.png", plot = export_plot, dpi = 300)


# Parasitemia

# Spearman correlation between temperature and parasitemia
cor_test_parasitemia <- cor.test(fever_data$temp, fever_data$parasitemia, method = "spearman")

# Print results
cat("Spearman correlation between temperature and parasitemia:\n")
cat("rho =", round(cor_test_parasitemia$estimate, 3), "\n")
cat("p-value =", signif(cor_test_parasitemia$p.value, 3), "\n")




# Fever and DE genes related to heat stress
se <- readRDS("de_covar/um_control/custom_1cpm_10_samples_ruv/summarized_de_filter.rds")

# Ensure transcript IDs are rownames and match your heat-related set
heat_transcripts <-  read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv/go_combined.tsv") %>% # go terms and transcript ids
  filter(desc == "response to heat") %>%
  select(transcript_id) %>%
  distinct() %>%
  pull() # this first dataset is the GO term of interest

heat_transcripts_2 <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv/go_combined.tsv") %>% 
  filter(str_detect(desc, "\\bheat\\b")) %>% 
  select(transcript_id) %>%
  distinct() %>%
  pull() # this second dataset has all GO terms with the word "heat" in them


heat_transcripts_3 <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/de_covar/um_control/custom_1cpm_10_samples_ruv/go_combined.tsv") %>%
  filter(desc %in% c(
    "unfolded protein binding",
    "intramolecular oxidoreductase activity",
    "transmembrane transporter activity",
    "chaperone binding",
    "protein homodimerization activity",
    "adenyl nucleotide binding",
    "protein binding",
    "peptidyl-prolyl cis-trans isomerase activity",
    "transferase activity, transferring one-carbon groups",
    "transferase activity, transferring alkyl or aryl groups, other than methyl groups",
    "protein folding",
    "gluconeogenesis",
    "glycolytic process",
    "response to heat",
    "protein targeting to mitochondrion",
    "response to unfolded protein",
    "carbohydrate metabolic process",
    "nucleobase-containing small molecule metabolic process",
    "regulation of hydrolase activity",
    "isoprenoid biosynthetic process",
    "Maurer's cleft",
    "host cell",
    "host cell periphery",
    "extracellular vesicle",
    "mitochondrion",
    "food vacuole",
    "integral component of plasma membrane",
    "infected host cell surface knob",
    "cytosolic part",
    "host cell membrane"
  )) %>%
  select(transcript_id) %>%
  distinct() %>%
  pull() # this third dataset has a more curated list of GO terms related to heat stress (https://www.nature.com/articles/s41467-021-24814-1#Sec9)

# Normalize counts if needed (here using logCPM as an example)
expr_mat <- assay(se, "counts") %>%
  cpm(log = TRUE, prior.count = 1)

# Subset for heat-related transcripts
expr_mat_heat <- expr_mat[intersect(rownames(expr_mat), heat_transcripts_3), , drop = FALSE]

# Match order of samples
expr_mat_heat <- expr_mat_heat[, colnames(expr_mat_heat) %in% fever_data$sampleid]
fever_data <- fever_data %>% filter(sampleid %in% colnames(expr_mat_heat))
expr_mat_heat <- expr_mat_heat[, fever_data$sampleid]  # ensure matching order

# Gather into long format
heat_expr_long <- as.data.frame(expr_mat_heat) %>%
  rownames_to_column("transcript_id") %>%
  pivot_longer(-transcript_id, names_to = "sampleid", values_to = "logCPM") %>%
  left_join(fever_data, by = "sampleid")

# Run correlation per gene
cor_results <- heat_expr_long %>%
  group_by(transcript_id) %>%
  summarise(
    cor = cor(logCPM, temp, method = "spearman"),
    p = cor.test(logCPM, temp, method = "spearman", exact = FALSE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(p_adj = p.adjust(p, method = "BH"))

cor_results %>%
  filter(p_adj < 0.05) 
```

# Is severe disease associated with parasitemia? Have eprformed somehwere else but can't find it...

```{R,eval=F}
library(consensusDE)
library(tidyverse)
library(readxl)
library(SummarizedExperiment)
library(edgeR)  # for cpm()
library(tidyverse)

# Fever and severity
fever_data <- read_tsv("/g/data/pq84/malaria/Pk_trancsriptomics/outputs/analyses/full_meta_for_de.tsv") %>%
  dplyr::select(studyid, sevemal, file, parasitemia) %>% 
  dplyr::rename(sampleid = file) %>%
  left_join(
    read_xlsx("/g/data/pq84/malaria/Parasite_and_human_genetic_risk_factors_for_Pk_malaria/human_genomics/axiom_array/outdir/analyses/Sabah_MASTER_patientsummary_22.2.23.xlsx") %>%
      dplyr::select(temp, code) %>%
      dplyr::rename(studyid = code)
  ) %>%
  na.omit()

# Run Wilcoxon test and extract p-value
wilcox_res <- wilcox.test(parasitemia ~ sevemal, data = fever_data)
pval <- signif(wilcox_res$p.value, 3)

```